(function(){var a,b,c=function(a,b){return function(){return a.apply(b,arguments)}},d=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};b=pimatic.tryCatch,$(document).on("pagecreate","#index",function(){return $(document).on("vclick","#to-graph-page",function(){var a,b;return b=$("#to-graph-page").attr("data-deviceId"),a=pimatic.getDeviceById(b),jQuery.mobile.pageParams={device:a},jQuery.mobile.changePage("#graph-page",{transition:"slide"})})}),$(document).on("pagecreate","#graph-page",function(){var a,e,f;e=function(){function a(){}return a.prototype.query=[],a.prototype.addTask=function(a,b){return null==b&&(b=!1),a.onComplete=function(b){return function(){return a.status="complete",b.next()}}(this),b?this.query.unshift(a):this.query.push(a),this.start()},a.prototype.start=function(){var a;if(0!==this.query.length&&(a=this.query[0],"running"!==a.status))return a.status="running",a.start()},a.prototype.next=function(){var a;return this.query=function(){var b,c,d,e;for(d=this.query,e=[],b=0,c=d.length;c>b;b++)a=d[b],"complete"!==a.status&&e.push(a);return e}.call(this),this.start()},a.prototype.clear=function(){var a,b,c,d;for(d=this.query,b=0,c=d.length;c>b;b++)a=d[b],null!=a.abort&&a.abort(),a.status="aborted";return this.query.length=0},a}(),a=function(){function a(){this.afterRenderAttribute=c(this.afterRenderAttribute,this);var a;ko.computed(b(function(a){return function(){var b,c,d,e;if(!a.pageCreated())return!1;for(e=pimatic.groups(),c=0,d=e.length;d>c;c++)b=e[c],b.devices();return pimatic["try"](function(){return $("#graph-device-list").listview("refresh")})}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}}),this.averageDurationText=ko.computed(b(function(a){return function(){return __("Average values of %s.",a.averageDuration())}}(this))),this.chosenDate($.datepicker.formatDate(this.dateFormat,new Date)),a=function(a){return"boolean"===a.type?"__state":a.unit},ko.computed(b(function(b){return function(){var c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W;if(k=b.displayedAttributes(),0===k.length)return null!=b.chart&&(b.chart.destroy(),b.chart=null),$("#chart").hide(),$("#chart-info").hide(),void $("#chart-no-data").hide();if(v=0,y=[],u=k.filter(function(a){return"number"===a.attribute.type}),u=u.concat(k.filter(function(a){return"boolean"===a.attribute.type})),k=u,b.dataLoadingQuery.clear(),w=b.chosenRange(),j=b.chosenDate(),null!=$.datepicker.parseDate(b.dateFormat,j)){for(m=b.getGroupByTimeForRange(w),b.averageDuration(b.timeDurationToText(m)),F=[],G=[],L=0,P=k.length;P>L;L++)q=k[L],q.added=!1,(q.range!==w||q.chosenDate!==j)&&(q.range=null,q.data=null),E=a(q.attribute),"boolean"===q.attribute.type&&(y[v]=q.attribute,q.stateOffset=v,v++),d.call(F,E)<0&&(F.push(E),G[E]=q.attribute);for(J=[],x=function(a){var b,c;return c=Math.floor(a),b=y[c],a=a!==c,b.formatValue(a)},A=[],h=M=0,Q=y.length;Q>M;h=++M)f=y[h],A.push({v:h,label:f.labels[1]}),A.push({v:h+.5,label:f.labels[0]});for(z=function(){return A},K=function(a){var b,c,d;return d=G[a],"__state"===a?(b=x,c=z):(b=function(a){return d.formatValue(a)},c=Dygraph.numericTicks),J.push({axisLabelFormatter:b,valueFormatter:b,ticker:c})},N=0,R=F.length;R>N;N++)D=F[N],K(D);for(V=b.getDateRange(),C=V.to,l=V.from,g=function(a){return 0===a?"y":"y"+(a+1)},i={labelsDiv:$("#chart-legend")[0],legend:"always",tooltip:"follow",staticLegend:!0,strokeWidth:2,pointSize:3,width:null,height:null,labels:["Date"],showRangeSelector:!0,connectSeparatedPoints:!0,rangeSelectorPlotStrokeColor:b.colors[0],rangeSelectorPlotFillColor:"#e0e6ec",xAxisHeight:35,highlightSeriesBackgroundAlpha:.9,highlightSeriesOpts:{},gridLineColor:"#BDBDBD",series:{},axes:{x:{valueFormatter:function(a){var b;return b=pimatic.timestampToDateTime(a),""+b.date+" "+b.time},pixelsPerLabel:25,axisTickSize:10}}},n=O=0,S=J.length;S>O;n=++O)I=J[n],i.axes[g(n)]=I;for(e=[],p=!1,H=function(){var a,c,d;return a=$("#chart"),c=$("#chart-no-data"),e.length>0?(c.hide(),p?(d={file:e},null!=i.axes.x.dateWindow&&(d.axes=i.axes),b.chart.updateOptions(d)):(null!=b.chart&&b.chart.destroy(),a.show().css("width","100%"),a.parent().css("padding-right",null!=i.axes.y2?0:"20px"),$("#chart-info").show(),b.chart=new Dygraph(a[0],e,i),p=!0)):c.show()},B=500,b.addChartData=function(a,c,d){var f,g,h,j,l,m,o,p,q,r,s;if(f=e,l=[],p=null!=(s=b.chart)?s.xAxisRange():void 0,null!=p&&e.length>0&&(j=p[1]===e[e.length-1][0].getTime()),"boolean"===c.attribute.type)for(r=0,q=d.length;q>r;r++)h=d[r],h[1]=h[1]?c.stateOffset+.5:c.stateOffset;if(0===d.length)l=e;else{for(o=d[0][0],g=0,m=0;m<d.length;){for(;g<f.length&&f[g][0].getTime()<o-B;)l.push(f[g]),g++;if(g<f.length&&m<d.length&&Math.abs(d[m][0]-f[g][0].getTime())<=B)f[g][a+1]=d[m][1],l.push(f[g]),g++,m++,m<d.length&&(o=d[m][0]);else{for(h=new Array(k.length+1),h[0]=new Date(d[m][0]),n=1;n<k.length+1;)h[n]=null,n++;h[a+1]=d[m][1],l.push(h),m++,m<d.length&&(o=d[m][0])}}for(;g<f.length;)l.push(f[g]),g++}return e=l,null!=p&&j&&(p[1]=e[e.length-1][0].getTime(),i.axes.x.dateWindow=p),H()},t=function(a,c,d,e){var f;return f={attributeName:a.attribute.name,abort:e||function(){}},f.start=function(){return pimatic.client.rest.querySingleDeviceAttributeEvents({deviceId:a.device.id,attributeName:a.attribute.name,criteria:{before:c,limit:1,order:"time",orderDirection:"desc"}},{global:!1}).done(function(a){return"aborted"!==f.status&&a.success?d(a.events):void 0}).always(function(){return"aborted"!==f.status?f.onComplete():void 0}).fail(function(){return e()})},b.dataLoadingQuery.addTask(f,!1)},r=100,s=function(a,c,d,e,f,g){var h;return null==g&&(g=!1),h={attributeName:a.attribute.name,abort:f||function(){}},h.start=function(){var b;return b=(new Date).getTime(),pimatic.client.rest.querySingleDeviceAttributeEvents({deviceId:a.device.id,attributeName:a.attribute.name,criteria:{after:c,before:d,limit:r,groupByTime:"number"!==a.attribute.type||a.attribute.discrete?void 0:m}},{global:!1}).done(function(c){var g,i,j,k;if("aborted"!==h.status&&c.success){if(g=c.events.length,i=g===r,!(g>0))return e(c.events,!1);if(k=(new Date).getTime()-b,k=Math.max(k,1),r=Math.floor(g*(3e3/k)),r=Math.max(r,100),e(c.events,i),i)return j=c.events[g-1],s(a,j.time+1,d,e,f,!0)}}).always(function(){return"aborted"!==h.status?h.onComplete():void 0}).fail(function(){return f()})},b.dataLoadingQuery.addTask(h,g)},c=function(c,e){var f,h,k,m,n,o,p,q,r;for(r=ko.utils.arrayIndexOf(F,a(e.attribute)),n=""+e.device.name()+": "+e.attribute.label,p=n,o=2;d.call(i.labels,n)>=0;)n=""+p+" "+o,o++;return q={axis:g(r),stepPlot:e.attribute.discrete,color:b.colors[c%b.colors.length],showInRangeSelector:0===c},"boolean"===e.attribute.type&&(q.strokePattern=Dygraph.DASHED_LINE),e.added=!0,e.chosenDate=j,e.range=w,e.index=c,e.serie(q),i.labels.push(n),i.series[n]=q,H(),f=[],m="loading-series-"+e.device.id+"_"+e.attribute.name,pimatic.loading(m,"show",{text:__("Loading data for "+e.device.name()+": "+e.attribute.label),blocking:!1}),k=function(a){var d,g,h;return d=function(){var b,c,d,e;for(e=[],c=0,b=a.length;b>c;c++)d=a[c],g=d.time,h=d.value,e.push([g,h]);return e}(),b.addChartData(c,e,d),f=f.concat(d)},h=function(){var a,b;return s(e,l.getTime(),C.getTime(),a=function(a,b){k(a),b||(e.data=f,e.range=w,pimatic.loading(m,"hide"))},b=function(){return pimatic.loading(m,"hide")})},e.attribute.discrete?t(e,l.getTime(),function(a){return 1===a.length&&(a[0].time=l.getTime()),k(a),h()}):h()},W=[],o=U=0,T=k.length;T>U;o=++U)q=k[o],W.push(c(o,q));return W}}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}})}return a.prototype.groups=pimatic.groups,a.prototype.displayedAttributes=ko.observableArray(),a.prototype.dateFrom=ko.observable(),a.prototype.dateTo=ko.observable(),a.prototype.chosenRange=ko.observable("day"),a.prototype.chosenDate=ko.observable(),a.prototype.pageCreated=ko.observable(!1),a.prototype.dataLoadingQuery=new e,a.prototype.averageDuration=ko.observable(null),a.prototype.dateFormat="yy-mm-dd",a.prototype.colors=["#7cb5ec","#434348","#90ed7d","#f7a35c","#8085e9","#f15c80","#e4d354","#8085e8","#8d4653","#91e8e1"],a.prototype.getUngroupedDevicesWithGraphableAttribute=function(){var a,b;return b=pimatic.getUngroupedDevices(),function(){var c,d,e;for(e=[],c=0,d=b.length;d>c;c++)a=b[c],a.hasAttibuteWith(function(){return function(a){var b;return"boolean"===(b=a.type)||"number"===b}}(this))&&e.push(a);return e}.call(this)},a.prototype.afterRenderAttribute=function(a){var b;return b=$(a).find("select"),pimatic["try"](function(){return function(){return b.flipswitch()}}(this))},a.prototype.getDisplayedAttribute=function(a,b){var c,d,e,f;for(f=this.displayedAttributes(),d=0,e=f.length;e>d;d++)if(c=f[d],c.device===a&&c.attribute===b)return c;return null},a.prototype.addToDisplayedAttributes=function(a,b){return null==this.getDisplayedAttribute(a,b)?this.displayedAttributes.push({device:a,attribute:b,serie:ko.observable()}):void 0},a.prototype.removeFromDisplayedAttributes=function(a,b){return this.displayedAttributes.remove(function(){return function(c){return c.device===a&&c.attribute===b}}(this))},a.prototype.isLive=function(){var a,b;return b=new Date,a=$.datepicker.parseDate(this.dateFormat,this.chosenDate()),null===a?!1:a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()},a.prototype.getDateRange=function(){var a,b,c,d;switch(c=this.chosenRange(),a=$.datepicker.parseDate(this.dateFormat,this.chosenDate()),this.isLive()?d=new Date:(d=new Date(a),d.setDate(d.getDate()+1)),b=new Date(d),c){case"day":b.setDate(d.getDate()-1);break;case"week":b.setDate(d.getDate()-7);break;case"month":b.setDate(d.getDate()-30);break;case"year":b.setDate(d.getDate()-365)}return{from:b,to:d}},a.prototype.getGroupByTimeForRange=function(a){var b;return b=function(){switch(a){case"day":return 3e5;case"week":return 18e5;case"month":return 72e5;case"year":return 144e5}}()},a.prototype.timeDurationToText=function(a){var b,c,d,e;return a/=1e3,e="",c=a/60,d=a%60,0!==d&&(e=""+d+"s "+e),0!==c&&(60>c?0!==c&&(e=""+c+"min "+e):(b=c/60,c%=60,e=0!==c?""+b+"h "+c+"min "+e:""+b+"h "+e)),e.trim()},a}(),pimatic.pages.graph=f=new a,ko.applyBindings(f,$("#graph-page")[0]),f.pageCreated(!0),$("#graph-page").on("click",".device-attribute-list .show-button",b(function(){var a,b;a=ko.dataFor(this),b=ko.dataFor($(this).parents(".graph-device")[0]),f.addToDisplayedAttributes(b,a)})),$("#graph-page").on("click",".device-attribute-list .hide-button",b(function(){var a,b;a=ko.dataFor(this),b=ko.dataFor($(this).parents(".graph-device")[0]),f.removeFromDisplayedAttributes(b,a)}))}),$(document).on("pagebeforeshow","#graph-page",function(){var a,b,c,d,e,f,g,h,i;if(c=pimatic.pages.graph,b=null!=(g=jQuery.mobile.pageParams)?g.device:void 0,jQuery.mobile.pageParams={},null!=b){for(d=[],h=b.attributes(),e=0,f=h.length;f>e;e++)a=h[e],("number"===(i=a.type)||"boolean"===i)&&d.push({device:b,attribute:a,serie:ko.observable()});c.displayedAttributes(d)}}),a=null,$(document).on("pagehide","#graph-page",function(){pimatic.pages.graph.dataLoadingQuery.clear(),null!=a&&pimatic.socket.removeListener("deviceAttributeChanged",a)}),$(document).on("pagebeforeshow","#graph-page",function(){var b;return b=pimatic.pages.graph,pimatic.socket.on("deviceAttributeChanged",a=function(a){var c,d,e,f;if(b.isLive())for(f=b.displayedAttributes(),d=0,e=f.length;e>d;d++)c=f[d],c.device.id===a.deviceId&&c.attribute.name===a.attributeName&&null!=c.serie&&null!=c.data&&c.added&&null!=c.index&&null!=b.addChartData&&(b.addChartData(c.index,c,[[new Date(a.time).getTime(),a.value]]),pimatic.showToast(__("%s: %s value: %s",c.device.name(),c.attribute.label,c.attribute.formatValue(a.value))))})})}).call(this);