(function(){var a,b,c=function(a,b){return function(){return a.apply(b,arguments)}},d=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};b=pimatic.tryCatch,$(document).on("pagecreate","#index",function(){return $("#index").on("click","#item-lists li.item .attributes.contains-attr-type-number",function(){var a,b;return a=null!=(b=ko.dataFor($(this).parent(".item")[0]))?b.device:void 0,jQuery.mobile.pageParams={device:a},jQuery.mobile.changePage("#graph-page",{transition:"slide"})})}),$(document).on("pagecreate","#graph-page",function(){var a,e;return Highcharts.setOptions({global:{useUTC:!1}}),a=function(){function a(){this.afterRenderAttribute=c(this.afterRenderAttribute,this),ko.computed(b(function(a){return function(){var b,c,d,e;if(!a.pageCreated())return!1;for(e=pimatic.groups(),c=0,d=e.length;d>c;c++)b=e[c],b.devices();return pimatic["try"](function(){return $("#graph-device-list").listview("refresh")})}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}}),ko.computed(b(function(a){return function(){var b,c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;if(h=a.displayedAttributes(),null!=(u=$("#chart").highcharts())&&u.destroy(),0===h.length)return void $("#chart").hide();for(l=a.chosenRange(),o=[],q=0,s=h.length;s>q;q++)j=h[q],v=j.attribute.unit,d.call(o,v)<0&&o.push(j.attribute.unit);for(p=function(){var a,b,c;for(c=[],a=0,b=o.length;b>a;a++)n=o[a],c.push({labels:{format:"{value} "+n},unit:n,tooltip:{valueDecimals:2,valueSuffix:" "+n},opposite:!1});return c}(),w=a.getDateRange(),m=w.to,i=w.from,g={tooltip:{valueDecimals:2},yAxis:p,xAxis:{type:"datetime",dateTimeLabelFormats:{millisecond:"%H:%M:%S",second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%e. %b",week:"%e. %b",month:"%b '%y",year:"%Y"}},rangeSelector:{enabled:!1},credits:{enabled:!1},series:[]},f=$("#chart").highcharts("StockChart",g),f.show(),f=f.highcharts(),e=function(a,b){var c;return c=ko.utils.arrayIndexOf(o,a.attribute.unit),{id:"serie-"+a.device.id+"-"+a.attribute.name,name:""+a.device.name()+": "+a.attribute.label,data:b,yAxis:c,tooltip:{valueDecimals:2,valueSuffix:" "+a.attribute.unit}}},k=function(a){return pimatic.client.rest.querySingleDeviceAttributeEvents({deviceId:a.device.id,attributeName:a.attribute.name,criteria:{after:i.getTime(),before:m.getTime()}})},c=function(a,b){var c,d;return pimatic["try"](function(){return f.reflow()}),d=e(a,b),c=f.addSeries(d),a.data=b,a.range=l,a.serie({id:d.id,index:c.index,color:c.color})},b=function(a){return null!=a.data&&a.range===l?c(a,a.data):k(a).done(function(b){var d,e,f;return b.success?(d=function(){var a,c,d,g,h;for(d=b.events,h=[],a=0,c=d.length;c>a;a++)g=d[a],e=g.time,f=g.value,h.push([e,f]);return h}(),c(a,d)):void 0})},x=[],r=0,t=h.length;t>r;r++)j=h[r],x.push(b(j));return x}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}})}return a.prototype.groups=pimatic.groups,a.prototype.displayedAttributes=ko.observableArray(),a.prototype.dateFrom=ko.observable(),a.prototype.dateTo=ko.observable(),a.prototype.chosenRange=ko.observable("day"),a.prototype.pageCreated=ko.observable(!1),a.prototype.getUngroupedDevicesWithNumericAttribute=function(){var a,b;return b=pimatic.getUngroupedDevices(),function(){var c,d,e;for(e=[],c=0,d=b.length;d>c;c++)a=b[c],a.hasAttibuteWith(function(){return function(a){return"number"===a.type}}(this))&&e.push(a);return e}.call(this)},a.prototype.afterRenderAttribute=function(a){var b;return b=$(a).find("select"),pimatic["try"](function(){return function(){return b.flipswitch()}}(this))},a.prototype.getDisplayedAttribute=function(a,b){var c,d,e,f;for(f=this.displayedAttributes(),d=0,e=f.length;e>d;d++)if(c=f[d],c.device===a&&c.attribute===b)return c;return null},a.prototype.addToDisplayedAttributes=function(a,b){return null==this.getDisplayedAttribute(a,b)?this.displayedAttributes.push({device:a,attribute:b,serie:ko.observable()}):void 0},a.prototype.removeFromDisplayedAttributes=function(a,b){return this.displayedAttributes.remove(function(){return function(c){return c.device===a&&c.attribute===b}}(this))},a.prototype.getDateRange=function(){var a,b,c;switch(b=this.chosenRange(),c=new Date,a=new Date,b){case"day":a.setDate(c.getDate()-1);break;case"week":a.setDate(c.getDate()-7);break;case"month":a.setDate(c.getDate()-30);break;case"year":a.setDate(c.getDate()-365)}return{from:a,to:c}},a}(),pimatic.pages.graph=e=new a,ko.applyBindings(e,$("#graph-page")[0]),e.pageCreated(!0),$("#graph-page").on("click",".device-attribute-list .show-button",b(function(){var a,b;a=ko.dataFor(this),b=ko.dataFor($(this).parents(".graph-device")[0]),e.addToDisplayedAttributes(b,a)})),$("#graph-page").on("click",".device-attribute-list .hide-button",b(function(){var a,b;a=ko.dataFor(this),b=ko.dataFor($(this).parents(".graph-device")[0]),e.removeFromDisplayedAttributes(b,a)}))}),$(document).on("pagebeforeshow","#graph-page",function(){var a,b,c,d,e,f,g;if(b=null!=(e=jQuery.mobile.pageParams)?e.device:void 0,jQuery.mobile.pageParams={},null!=b){for(f=b.attributes(),g=[],c=0,d=f.length;d>c;c++)a=f[c],g.push("number"===a.type?pimatic.pages.graph.addToDisplayedAttributes(b,a):void 0);return g}}),a=null,$(document).on("pagehide","#graph-page",function(){null!=a&&pimatic.socket.removeListener("deviceAttributeChanged",a)}),$(document).on("pagebeforeshow","#graph-page",function(){var b;return b=pimatic.pages.graph,pimatic.socket.on("deviceAttributeChanged",a=function(a){var c,d,e,f,g,h,i,j,k,l,m,n,o;for(n=b.displayedAttributes(),l=0,m=n.length;m>l;l++)f=n[l],f.device.id===a.deviceId&&f.attribute.name===a.attributeName&&null!=f.serie&&(i=$("#chart").highcharts().get(f.serie().id),g=[new Date(a.time).getTime(),a.value],j=!1,d=null,i.options.data.length>0&&(d=i.options.data[0]),null!=d&&(o=b.getDateRange(),e=o.from,k=o.to,d[0]<e.getTime()&&(j=!0)),i.addPoint(g,h=!0,j,c=!0),pimatic.showToast(__("%s: %s value: %s",f.device.name(),f.attribute.label,f.attribute.formatValue(a.value))))})})}).call(this);