(function(){var a,b,c=function(a,b){return function(){return a.apply(b,arguments)}},d=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};b=pimatic.tryCatch,$(document).on("pagecreate","#index",function(){return $(document).on("click","#to-graph-page",function(){var a,b;return b=$("#to-graph-page").attr("data-deviceId"),a=pimatic.getDeviceById(b),jQuery.mobile.pageParams={device:a},jQuery.mobile.changePage("#graph-page",{transition:"slide"})})}),$(document).on("pagecreate","#graph-page",function(){var a,e,f;e=function(){function a(){}return a.prototype.query=[],a.prototype.addTask=function(a,b){return null==b&&(b=!1),a.onComplete=function(b){return function(){return a.status="complete",b.next()}}(this),b?this.query.unshift(a):this.query.push(a),this.start()},a.prototype.start=function(){var a;if(0!==this.query.length&&(a=this.query[0],"running"!==a.status))return a.status="running",a.start()},a.prototype.next=function(){var a;return this.query=function(){var b,c,d,e;for(d=this.query,e=[],b=0,c=d.length;c>b;b++)a=d[b],"complete"!==a.status&&e.push(a);return e}.call(this),this.start()},a.prototype.clear=function(){var a,b,c,d;for(d=this.query,b=0,c=d.length;c>b;b++)a=d[b],null!=a.abort&&a.abort(),a.status="aborted";return this.query.length=0},a}(),a=function(){function a(){this.afterRenderAttribute=c(this.afterRenderAttribute,this),ko.computed(b(function(a){return function(){var b,c,d,e;if(!a.pageCreated())return!1;for(e=pimatic.groups(),c=0,d=e.length;d>c;c++)b=e[c],b.devices();return pimatic["try"](function(){return $("#graph-device-list").listview("refresh")})}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}}),this.averageDurationText=ko.computed(b(function(a){return function(){return __("Average values of %s.",a.averageDuration())}}(this))),this.chosenDate($.datepicker.formatDate(this.dateFormat,new Date)),ko.computed(b(function(a){return function(){var b,c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F;if(i=a.displayedAttributes(),null!=(C=$("#chart").highcharts())&&C.destroy(),0===i.length)return void $("#chart").hide();if(a.dataLoadingQuery.clear(),o=a.chosenRange(),h=a.chosenDate(),null!=$.datepicker.parseDate(a.dateFormat,h)){for(k=a.getGroupByTimeForRange(o),a.averageDuration(a.timeDurationToText(k)),r=[],s=[],w=0,z=i.length;z>w;w++)l=i[w],l.added=!1,(l.range!==o||l.chosenDate!==h)&&(l.range=null,l.data=null),D=l.attribute.unit,d.call(r,D)<0&&(r.push(l.attribute.unit),s[l.attribute.unit]=l.attribute);for(u=[],v=function(a){var b;return b=s[a],u.push({labels:{formatter:function(){return b.formatValue(this.value)}},unit:a,opposite:!1})},x=0,A=r.length;A>x;x++)q=r[x],v(q);for(E=a.getDateRange(),p=E.to,j=E.from,g={tooltip:{formatter:function(){var a,b,c,d,e,f,g,h;for(d=Highcharts.dateFormat("%A, %b %e, %H:%M:%S",this.points[0].key),b='<span style="font-size: 10px">'+d+"</span><br/>",h=this.points,f=0,g=h.length;g>f;f++)c=h[f],e=r[c.series.options.yAxis],a=s[e],b+='<span style="color:'+c.series.color+'">‚óè</span> \n'+c.series.name+": <b>"+a.formatValue(c.y)+"</b><br/>";return b}},yAxis:u,xAxis:{type:"datetime",dateTimeLabelFormats:{millisecond:"%H:%M:%S",second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%e. %b",week:"%e. %b",month:"%b '%y",year:"%Y"},tickPixelInterval:40,labels:{y:20,rotation:-30,align:"right"},ordinal:!1},rangeSelector:{enabled:!1},credits:{enabled:!1},legend:{enabled:!0,borderWidth:1,borderRadius:3},series:[]},f=$("#chart").highcharts("StockChart",g),f.show(),f=f.highcharts(),t=f.xAxis[0],e=function(a,b){var c;return c=ko.utils.arrayIndexOf(r,a.attribute.unit),{id:"serie-"+a.device.id+"-"+a.attribute.name,name:""+a.device.name()+": "+a.attribute.label,data:b,yAxis:c,type:a.attribute.discrete?"line":"spline"}},m=100,n=function(b,c,d,e,f,g){var h;return null==g&&(g=!1),h={attributeName:b.attribute.name,abort:f},h.start=function(){var a;return a=(new Date).getTime(),pimatic.client.rest.querySingleDeviceAttributeEvents({deviceId:b.device.id,attributeName:b.attribute.name,criteria:{after:c,before:d,limit:m,groupByTime:k}},{global:!1}).done(function(c){var g,i,j,k;if("aborted"!==h.status&&c.success){if(g=c.events.length,i=g===m,!(g>0))return e(c.events,!1);if(k=(new Date).getTime()-a,k=Math.max(k,1),m=Math.floor(g*(3e3/k)),m=Math.max(m,100),e(c.events,i),i)return j=c.events[g-1],n(b,j.time+1,d,e,f,!0)}}).always(function(){return"aborted"!==h.status?h.onComplete():void 0}).fail(function(){return f()})},a.dataLoadingQuery.addTask(h,g)},c=function(a,b){var c,d,g,i;return pimatic["try"](function(){return f.reflow()}),i=e(a,b),g=f.addSeries(i,d=!0,c=!1),a.added=!0,a.chosenDate=h,a.range=o,a.serie({id:i.id,index:g.index,color:g.color})},b=function(a){var b,d,e,g;return null!=a.data?c(a,a.data):(b=[],d="loading-series-"+a.device.id+"_"+a.attribute.name,pimatic.loading(d,"show",{text:__("Loading data for "+a.device.name()+": "+a.attribute.label),blocking:!1}),n(a,j.getTime(),p.getTime(),e=function(e,g){var h,i,k,l,m,n,q,r,s,u,v;if(a.attribute.discrete){if(i=[],e.length>0){for(k=b.length>0?b[b.length-1]:null,q=0,s=e.length;s>q;q++)v=e[q],m=v.time,n=v.value,null!=k&&i.push([m,k]),k=n,i.push([m,n]);g||null==k||i.push([p.getTime(),k])}}else i=function(){var a,b,c,d;for(d=[],a=0,b=e.length;b>a;a++)c=e[a],m=c.time,n=c.value,d.push([m,n]);return d}();if(a.added)for(l=f.get(a.serie().id),r=0,u=i.length;u>r;r++)h=i[r],l.addPoint(h,!1);else c(a,i);t.setExtremes(j.getTime(),p.getTime()),b=b.concat(i),g||(a.data=b,a.range=o,pimatic.loading(d,"hide"))},g=function(){return pimatic.loading(d,"hide")}))},F=[],y=0,B=i.length;B>y;y++)l=i[y],F.push(b(l));return F}}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}})}return a.prototype.groups=pimatic.groups,a.prototype.displayedAttributes=ko.observableArray(),a.prototype.dateFrom=ko.observable(),a.prototype.dateTo=ko.observable(),a.prototype.chosenRange=ko.observable("day"),a.prototype.chosenDate=ko.observable(),a.prototype.pageCreated=ko.observable(!1),a.prototype.dataLoadingQuery=new e,a.prototype.averageDuration=ko.observable(null),a.prototype.dateFormat="yy-mm-dd",a.prototype.getUngroupedDevicesWithNumericAttribute=function(){var a,b;return b=pimatic.getUngroupedDevices(),function(){var c,d,e;for(e=[],c=0,d=b.length;d>c;c++)a=b[c],a.hasAttibuteWith(function(){return function(a){return"number"===a.type}}(this))&&e.push(a);return e}.call(this)},a.prototype.afterRenderAttribute=function(a){var b;return b=$(a).find("select"),pimatic["try"](function(){return function(){return b.flipswitch()}}(this))},a.prototype.getDisplayedAttribute=function(a,b){var c,d,e,f;for(f=this.displayedAttributes(),d=0,e=f.length;e>d;d++)if(c=f[d],c.device===a&&c.attribute===b)return c;return null},a.prototype.addToDisplayedAttributes=function(a,b){return null==this.getDisplayedAttribute(a,b)?this.displayedAttributes.push({device:a,attribute:b,serie:ko.observable()}):void 0},a.prototype.removeFromDisplayedAttributes=function(a,b){return this.displayedAttributes.remove(function(){return function(c){return c.device===a&&c.attribute===b}}(this))},a.prototype.isLive=function(){var a,b;return b=new Date,a=$.datepicker.parseDate(this.dateFormat,this.chosenDate()),null===a?!1:a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()},a.prototype.getDateRange=function(){var a,b,c,d;switch(c=this.chosenRange(),a=$.datepicker.parseDate(this.dateFormat,this.chosenDate()),this.isLive()?d=new Date:(d=new Date(a),d.setDate(d.getDate()+1)),b=new Date(d),c){case"day":b.setDate(d.getDate()-1);break;case"week":b.setDate(d.getDate()-7);break;case"month":b.setDate(d.getDate()-30);break;case"year":b.setDate(d.getDate()-365)}return{from:b,to:d}},a.prototype.getGroupByTimeForRange=function(a){var b;return b=function(){switch(a){case"day":return 3e5;case"week":return 18e5;case"month":return 72e5;case"year":return 144e5}}()},a.prototype.timeDurationToText=function(a){var b,c,d,e;return a/=1e3,e="",c=a/60,d=a%60,0!==d&&(e=""+d+"s "+e),0!==c&&(60>c?0!==c&&(e=""+c+"min "+e):(b=c/60,c%=60,e=0!==c?""+b+"h "+c+"min "+e:""+b+"h "+e)),e.trim()},a}(),pimatic.pages.graph=f=new a,ko.applyBindings(f,$("#graph-page")[0]),f.pageCreated(!0),$("#graph-page").on("click",".device-attribute-list .show-button",b(function(){var a,b;a=ko.dataFor(this),b=ko.dataFor($(this).parents(".graph-device")[0]),f.addToDisplayedAttributes(b,a)})),$("#graph-page").on("click",".device-attribute-list .hide-button",b(function(){var a,b;a=ko.dataFor(this),b=ko.dataFor($(this).parents(".graph-device")[0]),f.removeFromDisplayedAttributes(b,a)}))}),$(document).on("pagebeforeshow","#graph-page",function(){var a,b,c,d,e,f,g,h;if(c=pimatic.pages.graph,b=null!=(g=jQuery.mobile.pageParams)?g.device:void 0,jQuery.mobile.pageParams={},null!=b){for(d=[],h=b.attributes(),e=0,f=h.length;f>e;e++)a=h[e],"number"===a.type&&d.push({device:b,attribute:a,serie:ko.observable()});c.displayedAttributes(d)}}),a=null,$(document).on("pagehide","#graph-page",function(){pimatic.pages.graph.dataLoadingQuery.clear(),null!=a&&pimatic.socket.removeListener("deviceAttributeChanged",a)}),$(document).on("pagebeforeshow","#graph-page",function(){var b;return b=pimatic.pages.graph,pimatic.socket.on("deviceAttributeChanged",a=function(a){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;if(b.isLive())for(o=b.displayedAttributes(),m=0,n=o.length;n>m;m++)f=o[m],f.device.id===a.deviceId&&f.attribute.name===a.attributeName&&null!=f.serie&&null!=f.data&&f.added&&(j=$("#chart").highcharts().get(f.serie().id),h=[new Date(a.time).getTime(),a.value],k=!1,d=null,j.options.data.length>0&&(d=j.options.data[0]),null!=d&&(p=b.getDateRange(),e=p.from,l=p.to,d[0]<e.getTime()&&(k=!0)),f.attribute.discrete&&f.data.length>0&&(g=f.data[f.data.length-1],j.addPoint([h[0],g[1]],i=!1,k,c=!1)),j.addPoint(h,i=!0,k,c=!0),pimatic.showToast(__("%s: %s value: %s",f.device.name(),f.attribute.label,f.attribute.formatValue(a.value))))})})}).call(this);