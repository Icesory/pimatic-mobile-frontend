(function(){var a;a=pimatic.tryCatch,$(document).on("pagebeforecreate",a(function(){var b,c,d,e,f;null==pimatic.pages.index&&(e=$("#sortable-handle-template").text(),c=function(){function a(a){ko.mapping.fromJS(a,this.constructor.mapping,this)}return a.mapping={key:function(a){return a.id},copy:["id"]},a.prototype.update=function(a){return ko.mapping.fromJS(a,this.constructor.mapping,this)},a.prototype.afterRender=function(a){return $(a).find("a").before($(e))},a}(),d=function(){function a(a){null==a.value&&(a.value=null),null==a.exprInputStr&&(a.exprInputStr=null),null==a.exprTokens&&(a.exprTokens=null),ko.mapping.fromJS(a,this.constructor.mapping,this),this.displayName=ko.computed(function(a){return function(){return"$"+a.name}}(this)),this.hasValue=ko.computed(function(a){return function(){return null!=a.value()}}(this)),this.displayValue=ko.computed(function(a){return function(){return a.hasValue()?a.value():"null"}}(this))}return a.mapping={key:function(a){return a.name},observe:["value","type","exprInputStr","exprTokens"]},a.prototype.isDeviceAttribute=function(){return-1!==$.inArray(".",this.name)},a.prototype.update=function(a){return ko.mapping.fromJS(a,this.constructor.mapping,this)},a.prototype.afterRender=function(a){return $(a).find("a").before($(e))},a}(),pimatic.Rule=c,pimatic.Variable=d,b=function(){function b(){var b,c,d;if(this.updateFromJs({items:[],rules:[],variables:[],errorCount:0,enabledEditing:!1,rememberme:!1,showAttributeVars:!1,ruleItemCssClass:"",hasRootCACert:!1,updateProcessStatus:"idle",updateProcessMessages:[]}),this.updateProcessStatus.subscribe(a(function(){return function(a){switch(a){case"running":return pimatic.loading("update-process-status","show",{text:__("Installing updates, Please be patient")});default:return pimatic.loading("update-process-status","hide")}}}(this))),this.setupStorage(),this.lockButton=ko.computed(a(function(a){return function(){var b;return b=a.enabledEditing(),{icon:b?"check":"gear"}}}(this))),this.visibleVars=ko.computed(a(function(a){return function(){return ko.utils.arrayFilter(a.variables(),function(b){return a.showAttributeVars()||!b.isDeviceAttribute()})}}(this))),this.itemsListViewRefresh=ko.computed(a(function(a){return function(){var b;if(a.items(),a.isSortingItems(),a.enabledEditing(),a.pageCreated())try{$("#items").listview("refresh").addClass("dark-background")}catch(c){b=c}return""}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}}),this.rulesListViewRefresh=ko.computed(a(function(a){return function(){var b;if(a.rules(),a.isSortingRules(),a.enabledEditing(),a.pageCreated())try{$("#rules").listview("refresh").addClass("dark-background")}catch(c){b=c}return""}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}}),this.variablesListViewRefresh=ko.computed(a(function(a){return function(){var b;if(a.variables(),a.enabledEditing(),a.showAttributeVars(),a.pageCreated())try{$("#variables").listview("refresh").addClass("dark-background")}catch(c){b=c}return""}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}}),pimatic.storage.isSet("pimatic.indexPage")){b=pimatic.storage.get("pimatic.indexPage");try{this.updateFromJs(b)}catch(e){c=e,TraceKit.report(c),pimatic.storage.removeAll(),window.location.reload()}}this.autosave=ko.computed(function(a){return function(){return b=ko.mapping.toJS(a),pimatic.storage.set("pimatic.indexPage",b)}}(this)).extend({rateLimit:{timeout:500,method:"notifyWhenChangesStop"}}),d=!0,this.rememberme.subscribe(a(function(a){return function(b){var c;return d?$.get("remember",{rememberMe:b}).done(ajaxShowToast).fail(function(){return d=!1,a.rememberme(!b)}).fail(ajaxAlertFail):d=!0,c=pimatic.storage.get("pimatic"),pimatic.storage.removeAll(),pimatic.storage=b?$.localStorage:$.sessionStorage,pimatic.storage.set("pimatic",c)}}(this))),this.toggleEditingText=ko.computed(a(function(a){return function(){return __(a.enabledEditing()?"Lock lists":"Edit lists")}}(this))),this.showAttributeVarsText=ko.computed(a(function(a){return function(){return __(a.showAttributeVars()?"Hide device attribute variables":"Show device attribute variables")}}(this)))}return b.mapping={items:{create:function(a){var b,c,d,e,f;return b=a.data,e=a.parent,f=a.skip,d=pimatic.templateClasses[b.template],null==d&&(console.warn("Could not find a template class for "+b.template),d=pimatic.Item),c=new d(b)},update:function(a){var b,c,d;return b=a.data,c=a.parent,d=a.target,d.update(b),d},key:function(a){return a.itemId}},rules:{create:function(a){var b,c,d;return b=a.data,c=a.parent,d=a.skip,new pimatic.Rule(b)},update:function(a){var b,c,d;return b=a.data,c=a.parent,d=a.target,d.update(b),d},key:function(a){return a.id}},variables:{create:function(a){var b,c,d;return b=a.data,c=a.parent,d=a.skip,new pimatic.Variable(b)},update:function(a){var b,c,d;return b=a.data,c=a.parent,d=a.target,d.update(b),d},key:function(a){return a.name}}},b.prototype.loading=!1,b.prototype.pageCreated=ko.observable(!1),b.prototype.items=ko.observableArray([]),b.prototype.rules=ko.observableArray([]),b.prototype.variables=ko.observableArray([]),b.prototype.errorCount=ko.observable(0),b.prototype.enabledEditing=ko.observable(!1),b.prototype.hasRootCACert=ko.observable(!1),b.prototype.rememberme=ko.observable(!1),b.prototype.showAttributeVars=ko.observable(!1),b.prototype.ruleItemCssClass=ko.observable(""),b.prototype.updateProcessStatus=ko.observable("idle"),b.prototype.updateProcessMessages=ko.observableArray([]),b.prototype.isSortingItems=ko.observable(!1),b.prototype.isSortingRules=ko.observable(!1),b.prototype.isSortingVariables=ko.observable(!1),b.prototype.setupStorage=function(){return $.localStorage.isSet("pimatic")?(pimatic.storage=$.localStorage,$.sessionStorage.removeAll(),this.rememberme(!0)):$.sessionStorage.isSet("pimatic")?(pimatic.storage=$.sessionStorage,$.localStorage.removeAll(),this.rememberme(!1)):(pimatic.storage=$.sessionStorage,this.rememberme(!1),pimatic.storage.set("pimatic",{}))},b.prototype.updateFromJs=function(a){return ko.mapping.fromJS(a,b.mapping,this)},b.prototype.getItemTemplate=function(a){var b;return b="device"===a.type?null!=a.template?""+a.template+"-template":"devie-template":"variable"===a.type?"variable-item-template":""+a.type+"-template",$("#"+b).length>0?b:"device-template"},b.prototype.afterRenderItem=function(a,b){return b.afterRender(a)},b.prototype.afterRenderRule=function(a,b){return b.afterRender(a)},b.prototype.afterRenderVariable=function(a,b){return b.afterRender(a)},b.prototype.addItemFromJs=function(a){var c;return c=b.mapping.items.create({data:a}),this.items.push(c)},b.prototype.addVariableFromJs=function(a){var c;return c=b.mapping.variables.create({data:a}),this.variables.push(c)},b.prototype.toggleShowAttributeVars=function(){return this.showAttributeVars(!this.showAttributeVars()),pimatic.loading("showAttributeVars","show",{text:__("Saving")}),$.ajax("/showAttributeVars/"+this.showAttributeVars(),{global:!1}).always(function(){return pimatic.loading("showAttributeVars","hide")}).done(ajaxShowToast)},b.prototype.removeItem=function(a){return this.items.remove(function(){return function(b){return b.itemId===a}}(this))},b.prototype.removeRule=function(a){return this.rules.remove(function(){return function(b){return b.id===a}}(this))},b.prototype.removeVariable=function(a){return this.variables.remove(function(){return function(b){return b.name===a}}(this))},b.prototype.updateRuleFromJs=function(a){var c;return c=ko.utils.arrayFirst(this.rules(),function(){return function(b){return b.id===a.id}}(this)),null==c?(c=b.mapping.rules.create({data:a}),this.rules.push(c)):c.update(a)},b.prototype.updateItemOrder=function(a){var b;return b=function(b){var c;return c=$.inArray(b,a),-1===c&&(c=999999),c},this.items.sort(function(){return function(a,c){return b(a.itemId)-b(c.itemId)}}(this))},b.prototype.updateRuleOrder=function(a){var b;return b=function(b){var c;return c=$.inArray(b,a),-1===c&&(c=999999),c},this.rules.sort(function(){return function(a,c){return b(a.id)-b(c.id)}}(this))},b.prototype.updateVariableOrder=function(a){var b;return b=function(b){var c;return c=$.inArray(b,a),-1===c&&(c=999999),c},this.variables.sort(function(){return function(a,c){return b(a.name)-b(c.name)}}(this))},b.prototype.updateDeviceAttribute=function(a,b,c){var d,e,f,g,h;for(g=this.items(),h=[],e=0,f=g.length;f>e;e++){if(d=g[e],"device"===d.type&&d.deviceId===a){d.updateAttribute(b,c);break}h.push(void 0)}return h},b.prototype.updateVariable=function(a){var b,c,d,e,f,g,h,i,j;for(h=this.variables(),d=0,f=h.length;f>d;d++)c=h[d],c.name===a.name&&c.update(a);for(i=this.items(),j=[],e=0,g=i.length;g>e;e++)b=i[e],j.push("variable"===b.type&&b.name===a.name?b.value(a.value):void 0);return j},b.prototype.toggleEditing=function(){return this.enabledEditing(!this.enabledEditing()),pimatic.loading("enableediting","show",{text:__("Saving")}),$.ajax("/enabledEditing/"+this.enabledEditing(),{global:!1}).always(function(){return pimatic.loading("enableediting","hide")}).done(ajaxShowToast)},b.prototype.onItemsSorted=function(){var a,b;return b=function(){var b,c,d,e;for(d=this.items(),e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.itemId);return e}.call(this),pimatic.loading("itemorder","show",{text:__("Saving")}),$.ajax("update-item-order",{type:"POST",global:!1,data:{order:b}}).always(function(){return pimatic.loading("itemorder","hide")}).done(ajaxShowToast).fail(ajaxAlertFail)},b.prototype.onRulesSorted=function(){var a,b;return a=function(){var a,c,d,e;for(d=this.rules(),e=[],a=0,c=d.length;c>a;a++)b=d[a],e.push(b.id);return e}.call(this),pimatic.loading("ruleorder","show",{text:__("Saving")}),$.ajax("update-rule-order",{type:"POST",global:!1,data:{order:a}}).always(function(){return pimatic.loading("ruleorder","hide")}).done(ajaxShowToast).fail(ajaxAlertFail)},b.prototype.onVariablesSorted=function(){var a,b;return a=function(){var a,c,d,e;for(d=this.variables(),e=[],a=0,c=d.length;c>a;a++)b=d[a],e.push(b.name);return e}.call(this),pimatic.loading("variableorder","show",{text:__("Saving")}),$.ajax("update-variable-order",{type:"POST",global:!1,data:{order:a}}).always(function(){return pimatic.loading("variableorder","hide")}).done(ajaxShowToast).fail(ajaxAlertFail)},b.prototype.onDropItemOnTrash=function(a){var b,c;return c=confirm(__("Do you really want to delete the item?")),c?(b=function(b){return function(){return pimatic.loading("deleteitem","show",{text:__("Saving")}),$.post("remove-item",{itemId:a.itemId}).done(function(c){return c.success?b.items.remove(a):void 0}).always(function(){return pimatic.loading("deleteitem","hide")}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this))():void 0},b.prototype.onDropRuleOnTrash=function(a){var b,c;return c=confirm(__("Do you really want to delete the %s rule?",a.name())),c?(b=function(b){return function(){return pimatic.loading("deleterule","show",{text:__("Saving")}),$.get("/api/rule/"+a.id+"/remove").done(function(c){return c.success?b.rules.remove(a):void 0}).always(function(){return pimatic.loading("deleterule","hide")}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this))():void 0},b.prototype.onDropVariableOnTrash=function(a){var b,c;return c=confirm(__("Do you really want to delete variable: %s?","$"+a.name)),c?(b=function(b){return function(){return pimatic.loading("deletevariable","show",{text:__("Saving")}),$.get("/api/variable/"+a.name+"/remove").done(function(c){return c.success?b.variables.remove(a):void 0}).always(function(){return pimatic.loading("deletevariable","hide")}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this))():void 0},b.prototype.onAddRuleClicked=function(){var a;return a=pimatic.pages.editRule,a.resetFields(),a.action("add"),a.ruleEnabled(!0),!0},b.prototype.onEditRuleClicked=function(a){var b;return b=pimatic.pages.editRule,b.action("update"),b.ruleId(a.id),b.ruleName(a.name()),b.ruleCondition(a.condition()),b.ruleActions(a.action()),b.ruleEnabled(a.active()),!0},b.prototype.onAddVariableClicked=function(){var a;return a=pimatic.pages.editVariable,a.resetFields(),a.action("add"),!0},b.prototype.onEditVariableClicked=function(a){var b;return a.isDeviceAttribute()?!1:(b=pimatic.pages.editVariable,b.variableName(a.name),b.variableValue("value"===a.type()?a.value():a.exprInputStr()),b.variableType(a.type()),b.action("update"),!0)},b.prototype.toLoginPage=function(){var a;return a=encodeURIComponent(window.location.href),window.location.href="/login?url="+a},b}(),pimatic.pages.index=f=new b,pimatic.socket.on("welcome",a(function(a){return f.updateFromJs(a)})),pimatic.socket.on("device-attribute",a(function(a){return f.updateDeviceAttribute(a.id,a.name,a.value)})),pimatic.socket.on("variable",a(function(a){return f.updateVariable(a)})),pimatic.socket.on("item-add",a(function(a){return f.addItemFromJs(a)})),pimatic.socket.on("item-remove",a(function(a){return f.removeItem(a)})),pimatic.socket.on("item-order",a(function(a){return f.updateItemOrder(a)})),pimatic.socket.on("rule-add",a(function(a){return f.updateRuleFromJs(a)})),pimatic.socket.on("rule-update",a(function(a){return f.updateRuleFromJs(a)})),pimatic.socket.on("rule-remove",a(function(a){return f.removeRule(a)})),pimatic.socket.on("rule-order",a(function(a){return f.updateRuleOrder(a)})),pimatic.socket.on("variable-add",a(function(a){return f.addVariableFromJs(a)})),pimatic.socket.on("variable-remove",a(function(a){return f.removeVariable(a)})),pimatic.socket.on("variable-order",a(function(a){return f.updateVariableOrder(a)})),pimatic.socket.on("update-process-status",a(function(a){return f.updateProcessStatus(a)})),pimatic.socket.on("update-process-message",a(function(a){return f.updateProcessMessages.push(a)})),pimatic.socket.on("log",a(function(a){return"error"===a.level?f.errorCount(f.errorCount()+1):void 0})))})),$(document).on("pagecreate","#index",a(function(){var b,c,d;c=pimatic.pages.index;try{ko.applyBindings(c,$("#index")[0])}catch(e){b=e,TraceKit.report(b),null!=(d=pimatic.storage)&&d.removeAll(),window.location.reload()}$("#index #items").on("change",".switch",a(function(){var a;a=ko.dataFor(this),a.onSwitchChange()})),$("#index #items").on("slidestop",".dimmer",a(function(){var a;a=ko.dataFor(this),a.onSliderStop()})),$("#index #items").on("vclick",".shutter-down",a(function(){var a;return a=ko.dataFor(this),a.onShutterDownClicked(),!1})),$("#index #items").on("vclick",".shutter-up",a(function(){var a;return a=ko.dataFor(this),a.onShutterUpClicked(),!1})),$("#items .handle, #rules .handle").disableSelection(),c.pageCreated(!0)}))}).call(this);