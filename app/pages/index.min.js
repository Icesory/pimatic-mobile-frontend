(function(){$(document).on("pagebeforecreate",function(){var a,b,c,d,e;null==pimatic.pages.index&&(d=$("#sortable-handle-template").text(),b=function(){function a(a){ko.mapping.fromJS(a,this.constructor.mapping,this)}return a.mapping={key:function(a){return a.id},copy:["id"]},a.prototype.update=function(a){return ko.mapping.fromJS(a,this.constructor.mapping,this)},a.prototype.afterRender=function(a){return $(a).find("a").before($(d))},a}(),c=function(){function a(a){null==a.value&&(a.value=null),null==a.exprInputStr&&(a.exprInputStr=null),null==a.exprTokens&&(a.exprTokens=null),ko.mapping.fromJS(a,this.constructor.mapping,this),this.displayName=ko.computed(function(a){return function(){return"$"+a.name}}(this)),this.hasValue=ko.computed(function(a){return function(){return null!=a.value()}}(this)),this.displayValue=ko.computed(function(a){return function(){return a.hasValue()?a.value():"null"}}(this))}return a.mapping={key:function(a){return a.name},observe:["value","type","exprInputStr","exprTokens"]},a.prototype.isDeviceAttribute=function(){return-1!==$.inArray(".",this.name)},a.prototype.update=function(a){return ko.mapping.fromJS(a,this.constructor.mapping,this)},a.prototype.afterRender=function(a){return $(a).find("a").before($(d))},a}(),pimatic.Rule=b,pimatic.Variable=c,a=function(){function a(){var a,b;this.setupStorage(),this.lockButton=ko.computed(function(a){return function(){var b;return b=a.enabledEditing(),{icon:b?"check":"gear"}}}(this)),this.visibleVars=ko.computed(function(a){return function(){return ko.utils.arrayFilter(a.variables(),function(b){return a.showAttributeVars()||!b.isDeviceAttribute()})}}(this)),this.itemsListViewRefresh=ko.computed(function(a){return function(){var b;if(a.items(),a.isSortingItems(),a.enabledEditing(),a.pageCreated())try{$("#items").listview("refresh")}catch(c){b=c}return""}}(this)).extend({rateLimit:{timeout:0,method:"notifyWhenChangesStop"}}),this.rulesListViewRefresh=ko.computed(function(a){return function(){var b;if(a.rules(),a.isSortingRules(),a.enabledEditing(),a.pageCreated())try{$("#rules").listview("refresh")}catch(c){b=c}return""}}(this)).extend({rateLimit:{timeout:0,method:"notifyWhenChangesStop"}}),this.variablesListViewRefresh=ko.computed(function(a){return function(){var b;if(a.variables(),a.enabledEditing(),a.showAttributeVars(),a.pageCreated())try{$("#variables").listview("refresh")}catch(c){b=c}return""}}(this)).extend({rateLimit:{timeout:0,method:"notifyWhenChangesStop"}}),pimatic.storage.isSet("pimatic.indexPage")&&(a=pimatic.storage.get("pimatic.indexPage"),this.updateFromJs(a)),this.autosave=ko.computed(function(b){return function(){return a=ko.mapping.toJS(b),pimatic.storage.set("pimatic.indexPage",a)}}(this)).extend({rateLimit:{timeout:500,method:"notifyWhenChangesStop"}}),b=!0,this.rememberme.subscribe(function(a){return function(c){var d;return b?$.get("remember",{rememberMe:c}).done(ajaxShowToast).fail(function(){return b=!1,a.rememberme(!c)}).fail(ajaxAlertFail):b=!0,d=pimatic.storage.get("pimatic"),pimatic.storage.removeAll(),pimatic.storage=c?$.localStorage:$.sessionStorage,pimatic.storage.set("pimatic",d)}}(this)),this.toggleEditingText=ko.computed(function(a){return function(){return __(a.enabledEditing()?"Lock lists":"Edit lists")}}(this)),this.showAttributeVarsText=ko.computed(function(a){return function(){return __(a.showAttributeVars()?"Hide device attribute variables":"Show device attribute variables")}}(this))}return a.mapping={items:{create:function(a){var b,c,d,e,f;return b=a.data,e=a.parent,f=a.skip,d=pimatic.templateClasses[b.template],null==d&&(console.warn("Could not find a template class for "+b.template),d=pimatic.Item),c=new d(b)},update:function(a){var b,c,d;return b=a.data,c=a.parent,d=a.target,d.update(b),d},key:function(a){return a.itemId}},rules:{create:function(a){var b,c,d;return b=a.data,c=a.parent,d=a.skip,new pimatic.Rule(b)},update:function(a){var b,c,d;return b=a.data,c=a.parent,d=a.target,d.update(b),d},key:function(a){return a.id}},variables:{create:function(a){var b,c,d;return b=a.data,c=a.parent,d=a.skip,new pimatic.Variable(b)},update:function(a){var b,c,d;return b=a.data,c=a.parent,d=a.target,d.update(b),d},key:function(a){return a.name}}},a.prototype.loading=!1,a.prototype.pageCreated=ko.observable(!1),a.prototype.items=ko.observableArray([]),a.prototype.rules=ko.observableArray([]),a.prototype.variables=ko.observableArray([]),a.prototype.errorCount=ko.observable(0),a.prototype.enabledEditing=ko.observable(!1),a.prototype.hasRootCACert=ko.observable(!1),a.prototype.rememberme=ko.observable(!1),a.prototype.showAttributeVars=ko.observable(!1),a.prototype.ruleItemCssClass=ko.observable(""),a.prototype.isSortingItems=ko.observable(!1),a.prototype.isSortingRules=ko.observable(!1),a.prototype.isSortingVariables=ko.observable(!1),a.prototype.setupStorage=function(){return $.localStorage.isSet("pimatic")?(pimatic.storage=$.localStorage,$.sessionStorage.removeAll(),this.rememberme(!0)):$.sessionStorage.isSet("pimatic")?(pimatic.storage=$.sessionStorage,$.localStorage.removeAll(),this.rememberme(!1)):(pimatic.storage=$.sessionStorage,this.rememberme(!1),pimatic.storage.set("pimatic",{}))},a.prototype.updateFromJs=function(b){return ko.mapping.fromJS(b,a.mapping,this)},a.prototype.getItemTemplate=function(a){var b;return b="device"===a.type?null!=a.template?""+a.template+"-template":"devie-template":"variable"===a.type?"variable-item-template":""+a.type+"-template",$("#"+b).length>0?b:"device-template"},a.prototype.afterRenderItem=function(a,b){return b.afterRender(a)},a.prototype.afterRenderRule=function(a,b){return b.afterRender(a)},a.prototype.afterRenderVariable=function(a,b){return b.afterRender(a)},a.prototype.addItemFromJs=function(b){var c;return c=a.mapping.items.create({data:b}),this.items.push(c)},a.prototype.addVariableFromJs=function(b){var c;return c=a.mapping.variables.create({data:b}),this.variables.push(c)},a.prototype.toggleShowAttributeVars=function(){return this.showAttributeVars(!this.showAttributeVars()),pimatic.loading("showAttributeVars","show",{text:__("Saving")}),$.ajax("/showAttributeVars/"+this.showAttributeVars(),{global:!1}).always(function(){return pimatic.loading("showAttributeVars","hide")}).done(ajaxShowToast)},a.prototype.removeItem=function(a){return this.items.remove(function(){return function(b){return b.itemId===a}}(this))},a.prototype.removeRule=function(a){return this.rules.remove(function(){return function(b){return b.id===a}}(this))},a.prototype.removeVariable=function(a){return this.variables.remove(function(){return function(b){return b.name===a}}(this))},a.prototype.updateRuleFromJs=function(b){var c;return c=ko.utils.arrayFirst(this.rules(),function(){return function(a){return a.id===b.id}}(this)),null==c?(c=a.mapping.rules.create({data:b}),this.rules.push(c)):c.update(b)},a.prototype.updateItemOrder=function(a){var b;return b=function(b){var c;return c=$.inArray(b,a),-1===c&&(c=999999),c},this.items.sort(function(){return function(a,c){return b(a.itemId)-b(c.itemId)}}(this))},a.prototype.updateRuleOrder=function(a){var b;return b=function(b){var c;return c=$.inArray(b,a),-1===c&&(c=999999),c},this.rules.sort(function(){return function(a,c){return b(a.id)-b(c.id)}}(this))},a.prototype.updateVariableOrder=function(a){var b;return b=function(b){var c;return c=$.inArray(b,a),-1===c&&(c=999999),c},this.variables.sort(function(){return function(a,c){return b(a.name)-b(c.name)}}(this))},a.prototype.updateDeviceAttribute=function(a,b,c){var d,e,f,g,h;for(g=this.items(),h=[],e=0,f=g.length;f>e;e++){if(d=g[e],"device"===d.type&&d.deviceId===a){d.updateAttribute(b,c);break}h.push(void 0)}return h},a.prototype.updateVariable=function(a){var b,c,d,e,f,g,h,i,j;for(h=this.variables(),d=0,f=h.length;f>d;d++)c=h[d],c.name===a.name&&c.update(a);for(i=this.items(),j=[],e=0,g=i.length;g>e;e++)b=i[e],j.push("variable"===b.type&&b.name===a.name?b.value(a.value):void 0);return j},a.prototype.toggleEditing=function(){return this.enabledEditing(!this.enabledEditing()),pimatic.loading("enableediting","show",{text:__("Saving")}),$.ajax("/enabledEditing/"+this.enabledEditing(),{global:!1}).always(function(){return pimatic.loading("enableediting","hide")}).done(ajaxShowToast)},a.prototype.onItemsSorted=function(){var a,b;return b=function(){var b,c,d,e;for(d=this.items(),e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.itemId);return e}.call(this),pimatic.loading("itemorder","show",{text:__("Saving")}),$.ajax("update-item-order",{type:"POST",global:!1,data:{order:b}}).always(function(){return pimatic.loading("itemorder","hide")}).done(ajaxShowToast).fail(ajaxAlertFail)},a.prototype.onRulesSorted=function(){var a,b;return a=function(){var a,c,d,e;for(d=this.rules(),e=[],a=0,c=d.length;c>a;a++)b=d[a],e.push(b.id);return e}.call(this),pimatic.loading("ruleorder","show",{text:__("Saving")}),$.ajax("update-rule-order",{type:"POST",global:!1,data:{order:a}}).always(function(){return pimatic.loading("ruleorder","hide")}).done(ajaxShowToast).fail(ajaxAlertFail)},a.prototype.onVariablesSorted=function(){var a,b;return a=function(){var a,c,d,e;for(d=this.variables(),e=[],a=0,c=d.length;c>a;a++)b=d[a],e.push(b.name);return e}.call(this),pimatic.loading("variableorder","show",{text:__("Saving")}),$.ajax("update-variable-order",{type:"POST",global:!1,data:{order:a}}).always(function(){return pimatic.loading("variableorder","hide")}).done(ajaxShowToast).fail(ajaxAlertFail)},a.prototype.onDropItemOnTrash=function(a){var b,c;return c=confirm(__("Do you really want to delete the item?")),c?(b=function(b){return function(){return pimatic.loading("deleteitem","show",{text:__("Saving")}),$.post("remove-item",{itemId:a.itemId}).done(function(c){return c.success?b.items.remove(a):void 0}).always(function(){return pimatic.loading("deleteitem","hide")}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this))():void 0},a.prototype.onDropRuleOnTrash=function(a){var b,c;return c=confirm(__("Do you really want to delete the %s rule?",a.name())),c?(b=function(b){return function(){return pimatic.loading("deleterule","show",{text:__("Saving")}),$.get("/api/rule/"+a.id+"/remove").done(function(c){return c.success?b.rules.remove(a):void 0}).always(function(){return pimatic.loading("deleterule","hide")}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this))():void 0},a.prototype.onDropVariableOnTrash=function(a){var b,c;return c=confirm(__("Do you really want to delete variable: %s?","$"+a.name)),c?(b=function(b){return function(){return pimatic.loading("deletevariable","show",{text:__("Saving")}),$.get("/api/variable/"+a.name+"/remove").done(function(c){return c.success?b.variables.remove(a):void 0}).always(function(){return pimatic.loading("deletevariable","hide")}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this))():void 0},a.prototype.onAddRuleClicked=function(){var a;return a=pimatic.pages.editRule,a.resetFields(),a.action("add"),a.ruleEnabled(!0),!0},a.prototype.onEditRuleClicked=function(a){var b;return b=pimatic.pages.editRule,b.action("update"),b.ruleId(a.id),b.ruleName(a.name()),b.ruleCondition(a.condition()),b.ruleActions(a.action()),b.ruleEnabled(a.active()),!0},a.prototype.onAddVariableClicked=function(){var a;return a=pimatic.pages.editVariable,a.resetFields(),a.action("add"),!0},a.prototype.onEditVariableClicked=function(a){var b;return a.isDeviceAttribute()?!1:(b=pimatic.pages.editVariable,b.variableName(a.name),b.variableValue("value"===a.type()?a.value():a.exprInputStr()),b.variableType(a.type()),b.action("update"),!0)},a.prototype.toLoginPage=function(){var a;return a=encodeURIComponent(window.location.href),window.location.href="/login?url="+a},a}(),pimatic.pages.index=e=new a,pimatic.socket.on("welcome",function(a){return e.updateFromJs(a)}),pimatic.socket.on("device-attribute",function(a){return e.updateDeviceAttribute(a.id,a.name,a.value)}),pimatic.socket.on("variable",function(a){return e.updateVariable(a)}),pimatic.socket.on("item-add",function(a){return e.addItemFromJs(a)}),pimatic.socket.on("item-remove",function(a){return e.removeItem(a)}),pimatic.socket.on("item-order",function(a){return e.updateItemOrder(a)}),pimatic.socket.on("rule-add",function(a){return e.updateRuleFromJs(a)}),pimatic.socket.on("rule-update",function(a){return e.updateRuleFromJs(a)}),pimatic.socket.on("rule-remove",function(a){return e.removeRule(a)}),pimatic.socket.on("rule-order",function(a){return e.updateRuleOrder(a)}),pimatic.socket.on("variable-add",function(a){return e.addVariableFromJs(a)}),pimatic.socket.on("variable-remove",function(a){return e.removeVariable(a)}),pimatic.socket.on("variable-order",function(a){return e.updateVariableOrder(a)}),pimatic.socket.on("log",function(a){return"error"===a.level?e.errorCount(e.errorCount()+1):void 0}))}),$(document).on("pagecreate","#index",function(){var a;a=pimatic.pages.index,ko.applyBindings(a,$("#index")[0]),$("#index #items").on("change",".switch",function(){var a;a=ko.dataFor(this),a.onSwitchChange()}),$("#index #items").on("slidestop",".dimmer",function(){var a;a=ko.dataFor(this),a.onSliderStop()}),$("#index #items").on("vclick",".shutter-down",function(){var a;return a=ko.dataFor(this),a.onShutterDownClicked(),!1}),$("#index #items").on("vclick",".shutter-up",function(){var a;return a=ko.dataFor(this),a.onShutterUpClicked(),!1}),$("#items .handle, #rules .handle").disableSelection(),a.pageCreated(!0)})}).call(this);