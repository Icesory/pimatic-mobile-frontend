(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};$(document).on("pagebeforecreate",function(){var c,d,e;if(null==pimatic.pages.editRule){c=function(){function c(b){this.ruleView=b,this.elementOptionsText=a(this.elementOptionsText,this),this.remove=a(this.remove,this),this.cancel=a(this.cancel,this),this.ok=a(this.ok,this),this.showDefaultSelection=a(this.showDefaultSelection,this),this.getElements=a(this.getElements,this),this.selectPredicate=a(this.selectPredicate,this),this.keypress=a(this.keypress,this),this.setInputValue=a(this.setInputValue,this),this.computedPredicateToken=ko.computed(function(a){return function(){var b,c,d,e,f;for(c="",a.justTrigger()&&(c+="trigger: "),f=a.elements(),d=0,e=f.length;e>d;d++)b=f[d],c+=b.match();return c}}(this)),this.computedToken=ko.computed(function(a){return function(){var b,c,d,e,f;if(c=a.computedPredicateToken(),a.forEnabled())for(f=a.forElements(),d=0,e=f.length;e>d;d++)b=f[d],c+=b.match();return c}}(this)),this.computedToken.subscribe(this.setInputValue),this.inputValue.subscribe(function(a){return function(b){return a.dontUpdate?void 0:(a.disableElementsInput(!0),clearTimeout(a._getElments),a._getElments=setTimeout(function(){return a.getElements(b,null,"input changed")},2e3))}}(this))}return c.prototype.visible=ko.observable(!1),c.prototype.presets=ko.observable([]),c.prototype.elements=ko.observable([]),c.prototype.forElements=ko.observable([]),c.prototype.presetsVisible=ko.observable(!0),c.prototype.elementsVisible=ko.observable(!0),c.prototype.forElementsVisible=ko.observable(!0),c.prototype.forEnabled=ko.observable(!1),c.prototype.parentOp=null,c.prototype.side="left",c.prototype.errors=ko.observable(!0),c.prototype.inputValue=ko.observable(!0),c.prototype.disablePredicateInput=ko.observable(!1),c.prototype.disableElementsInput=ko.observable(!1),c.prototype.justTrigger=ko.observable(!1),c.prototype.canRemove=ko.observable(!1),c.prototype.setInputValue=function(a){return this.dontUpdate=!0,this.inputValue(a),this.dontUpdate=!1},c.prototype.keypress=function(a,b){return 13===b.keyCode?(this.parse(this.inputValue(),!0),!1):!0},c.prototype.parse=function(a){return pimatic.client.rest.getRuleConditionHints({conditionInput:a}).done(function(a){return function(b){return b.success&&null!=b.hints.tree?(b.hints.tree.parent=a.parentOp,a.updateTree(b.hints.tree),a.visible(!1)):(a.errors(b.hints.errors),swal("Oops...",__(b.hints.errors[0]),"error"))}}(this))},c.prototype.refreshPresets=function(){return pimatic.client.rest.getPredicatePresets({}).done(function(a){return function(b){return b.success&&null!=b.presets?a.presets(b.presets):void 0}}(this))},c.prototype.updateTree=function(a){if(null==this.parentOp)return this.ruleView.tree(a);if(!this.side)throw new Error("illegal side: ",this.side);return this.parentOp[this.side]=a,this.ruleView.tree.valueHasMutated()},c.prototype.selectPredicate=function(a){return this.setInputValue(a.input),this.getElements(a.input,a.predicateProviderClass,"selectPredicate")},c.prototype.getElements=function(a,b){return 0===this.inputValue().length?this.showDefaultSelection():(this.disableElementsInput(!0),this.disablePredicateInput(!0),pimatic.client.rest.getPredicateInfo({input:a,predicateProviderClass:b}).done(function(a){return function(b){var c,d;return b.success&&null!=b.result.predicate?(a.justTrigger(b.result.predicate.justTrigger),c=b.result.elements,0===a.elements().length&&null==c&&(c=[{match:b.result.predicate.token,type:"text"}]),0===b.result.errors.length&&null!=c&&a.showElementSelection(c,b.result.forElements,null!=(null!=(d=b.result.predicate)?d["for"]:void 0)),a.errors(b.result.errors||[])):void 0}}(this)).always(function(a){return function(){return a.disableElementsInput(!1),a.disablePredicateInput(!1)}}(this)))},c.prototype.showDefaultSelection=function(){return this.presetsVisible(!0),this.elementsVisible(!1),this.forElementsVisible(!1),0===this.presets().length&&this.refreshPresets(),this.disableElementsInput(!1),this.disablePredicateInput(!1)},c.prototype.showElementSelection=function(a,c,d){var e,f,g,h,i,j,k,l,m,n,o;if(this.presetsVisible(!1),this.elementsVisible(!0),this.forEnabled(d),i=function(a){var b,c,d;for(c=0,d=a.length;d>c;c++)b=a[c],ko.isObservable(b.match)||(b.match=ko.observable(b.wildcardMatch&&"text"!==b.type?b.wildcard:b.match));return a},null!=this.eleSubscriptions)for(o=this.eleSubscriptions,k=0,m=o.length;m>k;k++)f=o[k],f.dispose();for(this.eleSubscriptions=[],i(a),h=!1,j=function(c){return function(d,e){return c.eleSubscriptions.push(e.match.subscribe(function(){var e,f,g,i;if(!h){for(h=!0,a=c.elements(),f=d+1;f<a.length;)e=a[f],null!=e.wildcard&&(null!=e.options&&(i=e.wildcard,b.call(e.options,i)<0&&e.options.unshift(e.wildcard)),e.match(e.wildcard)),f++;return h=!1,clearTimeout(c._getElments),g="select"===a[d].type?100:2e3,c._getElments=setTimeout(function(){return c.getElements(c.computedToken(),null,"element changed")},g)}}))}}(this),g=l=0,n=a.length;n>l;g=++l)e=a[g],j(g,e);return this.elements(a),this.forElements(null!=c?i(c):[]),this.forElementsVisible(null!=c)},c.prototype.showEmpty=function(a){var b;return this.side="right",this.parentOp=a,this.visible(!0),this.setInputValue(""),this.refreshPresets(),this.showDefaultSelection(),this.justTrigger(!1),this.canRemove(!1),b="ontouchstart"in window||navigator.msMaxTouchPoints,b?void 0:$("#rule-condition-input").focus()},c.prototype.editPredicate=function(a){var b;return this.side=(null!=(b=a.parent)?b.left:void 0)===a?"left":"right",this.parentOp=a.parent,this.visible(!0),this.canRemove(!0),this.setInputValue(this.ruleView.predicateToString(a.predicate)),this.getElements(this.inputValue())},c.prototype.ok=function(){return this.parse(this.inputValue(),!0)},c.prototype.cancel=function(){return null!=this.parentOp&&null===this.parentOp[this.side]&&(null!=this.parentOp.parent?("left"===this.side?this.parentOp.parent.left===this.parentOp?(this.parentOp.parent.left=this.parentOp.right,this.parentOp.parent.left.parent=this.parentOp.parent):this.parentOp.parent.right===this.parentOp&&(this.parentOp.parent.right=this.parentOp.right,this.parentOp.parent.right.parent=this.parentOp.parent):this.parentOp.parent.left===this.parentOp?(this.parentOp.parent.left=this.parentOp.left,this.parentOp.parent.left.parent=this.parentOp.parent):this.parentOp.parent.right===this.parentOp&&(this.parentOp.parent.right=this.parentOp.left,this.parentOp.parent.right.parent=this.parentOp.parent),this.ruleView.tree.valueHasMutated()):"left"===this.side?(this.parentOp.right.parent=void 0,this.ruleView.tree(this.parentOp.right)):(this.parentOp.left.parent=void 0,this.ruleView.tree(this.parentOp.left))),this.visible(!1)},c.prototype.remove=function(){return console.log(this.parentOp),null!=this.parentOp?(null!=this.parentOp.parent?"left"===this.side?this.parentOp.parent.left===this.parentOp?(this.parentOp.parent.left=this.parentOp.right,this.parentOp.parent.left.parent=this.parentOp.parent):this.parentOp.parent.right===this.parentOp&&(this.parentOp.parent.right=this.parentOp.right,this.parentOp.parent.right.parent=this.parentOp.parent):this.parentOp.parent.left===this.parentOp?(this.parentOp.parent.left=this.parentOp.left,this.parentOp.parent.left.parent=this.parentOp.parent):this.parentOp.parent.right===this.parentOp&&(this.parentOp.parent.right=this.parentOp.left,this.parentOp.parent.right.parent=this.parentOp.parent):"left"===this.side?(this.parentOp.right.parent=void 0,this.ruleView.tree(this.parentOp.right)):(this.parentOp.left.parent=void 0,this.ruleView.tree(this.parentOp.left)),this.ruleView.tree.valueHasMutated()):this.ruleView.tree(null),this.visible(!1)},c.prototype.elementOptionsText=function(a){return a.replace(/^\{(.*)\}$/,"Choose $1...")},c}(),d=function(){function b(){this.setGuiMode=a(this.setGuiMode,this),this.setTextMode=a(this.setTextMode,this),this.addOr=a(this.addOr,this),this.addAnd=a(this.addAnd,this),this.editPredicate=a(this.editPredicate,this),this.addCondition=a(this.addCondition,this),this.ruleAsText=ko.computed(function(a){return function(){return"text"===a.editMode()?"if "+a.ruleCondition()+" then "+a.ruleActions():"if "+a.getTreeAsString()+" then "+a.ruleActions()}}(this)),this.pageTitle=ko.computed(function(a){return function(){return __("add"===a.action()?"Add new rule":"Edit rule")}}(this)),pimatic.autoFillId(this.ruleName,this.ruleId,this.action),this.conditionInput=new c(this)}return b.prototype.autocompleteAjax=null,b.prototype.autocompleEnabled=!0,b.prototype.action=ko.observable("add"),b.prototype.ruleId=ko.observable(""),b.prototype.ruleName=ko.observable(""),b.prototype.ruleCondition=ko.observable(""),b.prototype.ruleActions=ko.observable(""),b.prototype.ruleEnabled=ko.observable(!0),b.prototype.ruleLogging=ko.observable(!0),b.prototype.tree=ko.observable(null),b.prototype.editMode=ko.observable("text"),b.prototype.resetFields=function(){return this.ruleId(""),this.ruleName(""),this.ruleCondition(""),this.ruleActions(""),this.ruleEnabled(!0),this.ruleLogging(!0)},b.prototype.addCondition=function(){return this.conditionInput.showEmpty(null)},b.prototype.editPredicate=function(a){return this.conditionInput.editPredicate(a)},b.prototype.addAnd=function(a){return this.addBinaryOp("and",a)},b.prototype.addOr=function(a){return this.addBinaryOp("or",a)},b.prototype.addBinaryOp=function(a,b){var c;return console.log(b),c={type:a,left:b,right:null},null!=b.parent?(b.parent.left===b?b.parent.left=c:b.parent.right=c,c.parent=b.parent,b.parent=c,this.tree.valueHasMutated()):(b.parent=c,this.tree(c)),this.conditionInput.showEmpty(c)},b.prototype.onSubmit=function(){var a;return pimatic.isValidId(this.ruleId())?(a={ruleId:this.ruleId(),rule:{ruleString:this.ruleAsText(),active:this.ruleEnabled(),name:this.ruleName(),logging:this.ruleLogging()}},function(){switch(this.action()){case"add":return pimatic.client.rest.addRuleByString(a);case"update":return pimatic.client.rest.updateRuleByString(a);default:throw new Error("Illegal rule action: "+this.action())}}.call(this).done(function(a){return a.success?$.mobile.changePage("#rules-page",{transition:"slide",reverse:!0}):alert(a.error)}).fail(ajaxAlertFail),!1):void alert(__(pimatic.invalidIdMessage))},b.prototype.onRemove=function(){var a;return a=confirm(__("Do you really want to delete the %s rule?",this.ruleName())),a&&pimatic.client.rest.removeRule({ruleId:this.ruleId()}).done(function(a){return a.success?$.mobile.changePage("#rules-page",{transition:"slide",reverse:!0}):alert(a.error)}).fail(ajaxAlertFail),!1},b.prototype.onCopy=function(){var a,b,c,d;return c=this.ruleId(),d=this.ruleName(),this.action("add"),null!=(a=d.match(/.*?([0-9]+)$/))?(b=a[1],this.ruleName(d.substring(0,d.length-b.length-1)+(parseInt(b,10)+1))):this.ruleName(d+" 2"),null!=(a=c.match(/.*?([0-9]+)$/))?(b=a[1],this.ruleId(c.substring(0,c.length-b.length-1)+(parseInt(b,10)+1))):this.ruleId(c+"-2")},b.prototype.predicateToString=function(a){var b;return b=a.justTrigger?"trigger: ":"",b+=a.token,null!=a["for"]&&(b+=" for "+a["for"].token),b},b.prototype.getTreeAsString=function(){var a,b;return b=this.tree(),null==b?"":(a=function(b){return function(c,d){var e,f;if(null==c)return"";switch(c.type){case"predicate":return b.predicateToString(c.predicate);default:return e=""+a(c.left,c)+" "+c.type+" "+a(c.right,c),f=null!=d&&d.type!==c.type,f?"["+e+"]":e}}}(this))(b)},b.prototype.setTextMode=function(){return this.ruleCondition(this.getTreeAsString()),this.editMode("text")},b.prototype.setGuiMode=function(){var a;return a=function(b,c){return b.parent=c,null!=b.left&&a(b.left,b),null!=b.right&&a(b.right,b),b},pimatic.client.rest.getRuleConditionHints({conditionInput:this.ruleCondition()},{global:!0}).done(function(b){return function(c){return c.success?0===c.hints.errors.length?(b.tree(null!=c.hints.tree?a(c.hints.tree):null),b.editMode("gui")):swal("Oops...",__(c.hints.errors[0]),"error"):void 0}}(this)).fail(ajaxAlertFail)},b}();try{pimatic.pages.editRule=new d}catch(f){e=f,TraceKit.report(e)}}}),$(document).on("pagecreate","#edit-rule",function(){var a,b,c,d;try{return ko.applyBindings(pimatic.pages.editRule,$("#edit-rule")[0]),a=function(a,b){var c;return c=this.ac.getCommonPart(a,b),a.substring(0,a.length-c.length)+b},b=function(a){var b,c;return b=this.ac.getCommonPart(this.lastTerm,a),c=a.substring(b.length,a.length),"<strong>"+b+"</strong>"+c},d=pimatic.pages.editRule,$("#edit-rule-condition").textcomplete([{match:/^(.*)$/,search:function(a,b){var c,e;return null!=(e=d.autocompleteAjax)&&e.abort(),c={autocomplete:[],format:[]},pimatic.pages.editRule.autocompleEnabled?d.autocompleteAjax=pimatic.client.rest.getRuleConditionHints({conditionInput:a},{global:!1}).done(function(d){return function(e){var f,g;return c.autocomplete=(null!=(f=e.hints)?f.autocomplete:void 0)||[],c.format=(null!=(g=e.hints)?g.format:void 0)||[],e.error&&console.log(e.error),d.lastTerm=a,b(c)}}(this)).fail(function(){return function(){return b(c)}}(this)):b(c)},index:1,replace:function(b,c){var e;return e=a.call(this,b,c),d.ruleCondition(e),e},change:function(a){return d.ruleCondition(a)},template:b}]),$("#edit-rule-actions").textcomplete([{match:/^(.*)$/,search:function(a,b){var c,e;return c={autocomplete:[],format:[]},pimatic.pages.editRule.autocompleEnabled?(null!=(e=d.autocompleteAjax)&&e.abort(),d.autocompleteAjax=pimatic.client.rest.getRuleActionsHints({actionsInput:a},{global:!1}).done(function(d){return function(e){var f,g;return c.autocomplete=(null!=(f=e.hints)?f.autocomplete:void 0)||[],c.format=(null!=(g=e.hints)?g.format:void 0)||[],null!=e.message&&e.message.length>0&&pimatic.showToast(e.message[0]),e.error&&console.log(e.error),d.lastTerm=a,b(c)}}(this)).fail(function(){return function(){return b(c)}}(this))):b(c)},index:1,replace:function(b,c){var e;return e=a.call(this,b,c),d.ruleActions(e),e},change:function(a){return d.ruleActions(a)},template:b}])}catch(e){return c=e,TraceKit.report(c)}}),$(document).on("pagebeforehide","#edit-rule",function(){var a,b;try{return null!=(b=pimatic.pages.editRule.autocompleteAjax)?b.abort():void 0}catch(c){return a=c,TraceKit.report(a)}}),$(document).on("pagebeforeshow","#edit-rule",function(){var a,b,c;a=pimatic.pages.editRule,b=jQuery.mobile.pageParams,jQuery.mobile.pageParams={},"update"===(null!=b?b.action:void 0)?(c=b.rule,a.action("update"),a.ruleId(c.id),a.ruleName(c.name()),a.ruleCondition(c.conditionToken()),a.ruleActions(c.actionsToken()),a.ruleEnabled(c.active()),a.ruleLogging(c.logging())):(a.resetFields(),a.action("add"),a.ruleEnabled(!0)),a.setGuiMode()})}).call(this);