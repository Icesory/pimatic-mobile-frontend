(function(){$(document).on("pagebeforecreate",function(){var a,b;if(null==pimatic.pages.editRule){a=function(){function a(){this.ruleAsText=ko.computed(function(a){return function(){return"if "+a.ruleCondition()+" then "+a.ruleActions()}}(this)),this.pageTitle=ko.computed(function(a){return function(){return __("add"===a.action()?"Add new rule":"Edit rule")}}(this)),pimatic.autoFillId(this.ruleName,this.ruleId,this.action)}return a.prototype.autocompleteAjax=null,a.prototype.autocompleEnabled=!0,a.prototype.action=ko.observable("add"),a.prototype.ruleId=ko.observable(""),a.prototype.ruleName=ko.observable(""),a.prototype.ruleCondition=ko.observable(""),a.prototype.ruleActions=ko.observable(""),a.prototype.ruleEnabled=ko.observable(!0),a.prototype.ruleLogging=ko.observable(!0),a.prototype.resetFields=function(){return this.ruleId(""),this.ruleName(""),this.ruleCondition(""),this.ruleActions(""),this.ruleEnabled(!0),this.ruleLogging(!0)},a.prototype.onSubmit=function(){var a;return pimatic.isValidId(this.ruleId())?(a={ruleId:this.ruleId(),rule:{ruleString:this.ruleAsText(),active:this.ruleEnabled(),name:this.ruleName(),logging:this.ruleLogging()}},function(){switch(this.action()){case"add":return pimatic.client.rest.addRuleByString(a);case"update":return pimatic.client.rest.updateRuleByString(a);default:throw new Error("Illegal rule action: "+action())}}.call(this).done(function(a){return a.success?$.mobile.changePage("#rules-page",{transition:"slide",reverse:!0}):alert(a.error)}).fail(ajaxAlertFail),!1):void alert(__("Please enter a valid id."))},a.prototype.onRemove=function(){var a;return a=confirm(__("Do you really want to delete the %s rule?",this.ruleName())),a&&pimatic.client.rest.removeRule({ruleId:this.ruleId()}).done(function(a){return a.success?$.mobile.changePage("#rules-page",{transition:"slide",reverse:!0}):alert(a.error)}).fail(ajaxAlertFail),!1},a.prototype.onCopy=function(){var a,b,c,d;return c=this.ruleId(),d=this.ruleName(),this.action("add"),null!=(a=d.match(/.*?([0-9]+)$/))?(b=a[1],this.ruleName(d.substring(0,d.length-b.length-1)+(parseInt(b,10)+1))):this.ruleName(d+" 2"),null!=(a=c.match(/.*?([0-9]+)$/))?(b=a[1],this.ruleId(c.substring(0,c.length-b.length-1)+(parseInt(b,10)+1))):this.ruleId(c+"-2")},a}();try{pimatic.pages.editRule=new a}catch(c){b=c,TraceKit.report(b)}}}),$(document).on("pagecreate","#edit-rule",function(){var a,b,c,d;try{return ko.applyBindings(pimatic.pages.editRule,$("#edit-rule")[0]),a=function(a,b){var c;return c=this.ac.getCommonPart(a,b),a.substring(0,a.length-c.length)+b},b=function(a){var b,c;return b=this.ac.getCommonPart(this.lastTerm,a),c=a.substring(b.length,a.length),"<strong>"+b+"</strong>"+c},d=pimatic.pages.editRule,$("#edit-rule-condition").textcomplete([{match:/^(.*)$/,search:function(a,b){var c,e;return null!=(e=d.autocompleteAjax)&&e.abort(),c={autocomplete:[],format:[]},pimatic.pages.editRule.autocompleEnabled?d.autocompleteAjax=pimatic.client.rest.getRuleConditionHints({conditionInput:a},{global:!1}).done(function(d){return function(e){var f,g;return c.autocomplete=(null!=(f=e.hints)?f.autocomplete:void 0)||[],c.format=(null!=(g=e.hints)?g.format:void 0)||[],e.error&&console.log(e.error),d.lastTerm=a,b(c)}}(this)).fail(function(){return function(){return b(c)}}(this)):b(c)},index:1,replace:function(b,c){var e;return e=a.call(this,b,c),d.ruleCondition(e),e},template:b}]),$("#edit-rule-actions").textcomplete([{match:/^(.*)$/,search:function(a,b){var c,e;return c={autocomplete:[],format:[]},pimatic.pages.editRule.autocompleEnabled?(null!=(e=d.autocompleteAjax)&&e.abort(),d.autocompleteAjax=pimatic.client.rest.getRuleActionsHints({actionsInput:a},{global:!1}).done(function(d){return function(e){var f,g;return c.autocomplete=(null!=(f=e.hints)?f.autocomplete:void 0)||[],c.format=(null!=(g=e.hints)?g.format:void 0)||[],null!=e.message&&e.message.length>0&&pimatic.showToast(e.message[0]),e.error&&console.log(e.error),d.lastTerm=a,b(c)}}(this)).fail(function(){return function(){return b(c)}}(this))):b(c)},index:1,replace:function(b,c){var e;return e=a.call(this,b,c),d.ruleActions(e),e},template:b}])}catch(e){return c=e,TraceKit.report(c)}}),$(document).on("pagebeforehide","#edit-rule",function(){var a,b;try{return null!=(b=pimatic.pages.editRule.autocompleteAjax)?b.abort():void 0}catch(c){return a=c,TraceKit.report(a)}})}).call(this);