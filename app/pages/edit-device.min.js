(function(){var a,b,c;a=Array.prototype.concat,LazyLoad.js(a.apply(scripts.jsoneditor)),c=function(a,b){var d,e,f,g,h,i,j;if(null==a)return ko.observable(b);switch(a.type){case"string":case"number":case"integer":case"boolean":return ko.observable(b);case"object":if(null==b)return ko.observable(b);if(null!=a.properties){j=a.properties;for(f in j)g=j[f],b[f]=c(g,b[f])}return ko.observable(b);case"array":if(null==b)return ko.observableArray(b);for(e=h=0,i=b.length;i>h;e=++h)d=b[e],b[e]=c(a.items,b[e]);return ko.observableArray(b);default:return ko.observable(b)}},b=function(a){var c,d,e,f,g,h,i,j;if(a=ko.unwrap(a),null==a)return a;switch(h=a,g=Array.isArray(a)?"array":typeof a){case"object":h={};for(e in a)f=a[e],h[e]=b(f);break;case"array":for(h=[],d=i=0,j=a.length;j>i;d=++i)c=a[d],h[d]=b(c)}return h},$(document).on("pagebeforecreate","#edit-device-page",function(){var a,d;if(null==pimatic.pages.editDevice){a=function(){function a(){var a,d,e,f,g,h,i,j,k,l;this.pageTitle=ko.computed(function(a){return function(){return __("add"===a.action()?"Add New Device":"Edit Device")}}(this)),f=$("#device-json-editor"),pimatic.autoFillId(this.deviceName,this.deviceId,this.action),g=function(a){return function(){var b,c,d,e,f;if(null!=a.editor){d=a.deviceConfig(),b={},c=0;for(e in d)f=d[e],"name"!==e&&"id"!==e&&"class"!==e&&(b[e]=f,c++);return console.log("confCopy:",b),0!==c?a.editor.setValue(b):void 0}}}(this),k=function(a){var b,c;return null==this.properties?[]:(a=ko.unwrap(a),function(){var d,e;d=this.properties,e=[];for(b in d)c=d[b],e.push({schema:c,value:a[b]});return e}.call(this))},j=function(a){var b;return null==ko.unwrap(a)?[]:function(){var c,d,e,f;for(e=ko.unwrap(a),f=[],c=0,d=e.length;d>c;c++)b=e[c],f.push({schema:this.items||{},value:b});return f}.call(this)},l=function(a,d){return d.schema.editingItem({schema:d.schema,value:c(d.schema,b(d.value)),index:a})},e=function(a,b){var c,d;return d=b.schema.editingItem(),null!=d.index?(c=ko.unwrap(a.value),c[d.index](d.value())):a.value.push(d.value),b.schema.editingItem(null)},d=function(a){return a.schema.editingItem(null)},a=function(a){var b;switch(null!=a.schema.items["default"]&&(b=c(a.schema.items,JSON.parse(JSON.stringify(a.schema.items["default"])))),a.schema.items.type){case"string":b=c(a.schema.items,"");break;case"number":case"integer":b=c(a.schema.items,0);break;case"boolean":b=c(a.schema.items,!1);break;case"object":b=c(a.schema.items,{});break;case"array":b=c(a.schema.items,[])}a.schema.items.editingItem({schema:a.schema.items,value:b})},i=function(a){var c,d;return d=b(a),console.log(d),"object"===this.type&&null!=this.properties&&(c="",null!=this.properties.name&&(c=d.name),null!=this.properties.id&&(c.length>0?c+=" ("+d.id+")":c=d.id),null!=c&&c.length>0)?c:JSON.stringify(d)},h=function(b,c){var f,g;switch(b.name=c,b.type){case"object":if(b.getProperties=k,null!=b.properties){g=b.properties;for(c in g)f=g[c],h(f,c)}break;case"array":b.getItems=j,null==b.items&&(b.items={}),b.items.getItemLabel=i,b.items.onEditItemClick=l,b.items.editOk=e,b.items.editCancel=d,b.items.addItem=a,b.items.editingItem=ko.observable(null),h(b.items,null)}},this.deviceClass.subscribe(function(a){return function(d){return null!=d&&"string"==typeof d&&d.length>0?pimatic.client.rest.getDeviceConfigSchema({className:d}).done(function(d){var e,f,g;return null!=d.success?(f=d.configSchema,delete f.properties.id,delete f.properties.name,delete f.properties["class"],g=b(a.deviceConfig()),e=c(f,g),a.deviceConfig(e()),h(f,null),a.configSchema(f)):void 0}):void 0}}(this))}return a.prototype.action=ko.observable("add"),a.prototype.deviceName=ko.observable(""),a.prototype.deviceId=ko.observable(""),a.prototype.deviceClass=ko.observable(""),a.prototype.deviceClasses=ko.observableArray(),a.prototype.deviceConfig=ko.observable({}),a.prototype.configSchema=ko.observable(null),a.prototype.editor=null,a.prototype.resetFields=function(){return this.deviceName(""),this.deviceId(""),this.deviceConfig({}),this.deviceClass("")},a.prototype.onSubmit=function(){var a;return a=b(this.deviceConfig()),a.id=this.deviceId(),a.name=this.deviceName(),a["class"]=this.deviceClass(),console.log(a),function(){switch(this.action()){case"add":return pimatic.client.rest.addDeviceByConfig({deviceConfig:a});case"update":return pimatic.client.rest.updateDeviceByConfig({deviceConfig:a});default:throw new Error("Illegal devicedevice action: "+action())}}.call(this).done(function(a){return a.success?$.mobile.changePage("#devices-page",{transition:"slide",reverse:!0}):alert(a.error)}).fail(ajaxAlertFail),!1},a.prototype.onRemove=function(){var a;return a=confirm(__("Do you really want to delete the %s device?",this.deviceName())),a&&pimatic.client.rest.removeDevice({deviceId:this.deviceId()}).done(function(a){return a.success?$.mobile.changePage("#devices-page",{transition:"slide",reverse:!0}):alert(a.error)}).fail(ajaxAlertFail),!1},a}();try{pimatic.pages.editDevice=new a}catch(e){d=e,TraceKit.report(d)}}}),$(document).on("pagebeforeshow","#edit-device-page",function(){return pimatic.client.rest.getDeviceClasses({}).done(function(){return function(a){return a.success?pimatic.pages.editDevice.deviceClasses(a.deviceClasses):void 0}}(this))}),$(document).on("pagecreate","#edit-device-page",function(){var a;try{return ko.applyBindings(pimatic.pages.editDevice,$("#edit-device-page")[0])}catch(b){return a=b,TraceKit.report(a)}}),$(document).on("pagebeforeshow","#edit-device-page",function(){var a,b,c;b=pimatic.pages.editDevice,c=jQuery.mobile.pageParams,jQuery.mobile.pageParams={},"update"===(null!=c?c.action:void 0)?(a=c.device,b.action("update"),b.deviceId(a.id),b.deviceName(a.name()),b.deviceConfig(a.config),b.deviceClass(a.config["class"])):(b.resetFields(),b.action("add"))})}).call(this);