(function(){var a,b,c,d,e,f,g;b=function(){function a(a){null==a.value&&(a.value=null),ko.mapping.fromJS(a,this.constructor.mapping,this),this.valueText=ko.computed(function(a){return function(){var b;return b=a.value(),null==b?__("unknown"):"boolean"===a.type?null==a.labels?b.toString():b===!0?a.labels[0]:b===!1?a.labels[1]:b.toString():b.toString()}}(this)),this.unitText=null!=this.unit?this.unit:""}return a.mapping={observe:["value"]},a.prototype.update=function(a){return ko.mapping.fromJS(a,this.constructor.mapping,this)},a.prototype.formatValue=function(a){return"boolean"===this.type?this.labels?a===!0?this.labels[0]:this.labels[1]:a.toString():null!=this.unit&&this.unit.length>0?""+a+" "+this.unit:a},a}(),a=function(){function a(a){var b,c,d,e;for(ko.mapping.fromJS(a,this.constructor.mapping,this),this.config=a.config,this.configObserve=ko.observable(a.config),this.rest={},e=this.actions,c=0,d=e.length;d>c;c++)b=e[c],pimatic.client.createRestAction(this.rest,b.name,b,{type:"get",url:"/api/device/"+this.id+"/"+b.name});this.group=ko.computed(function(a){return function(){return"null"===a.id?null:pimatic.getGroupOfDevice(a.id)}}(this)),this.configWithDefaults=ko.computed(function(a){return function(){var b,c,d,e,f;d={},e=a.configDefaults;for(c in e)b=e[c],d[c]=b;f=a.configObserve();for(c in f)b=f[c],d[c]=b;return d}}(this))}return a.mapping={attributes:{create:function(a){var c,d,e;return c=a.data,d=a.parent,e=a.skip,new b(c)},update:function(a){var b,c,d;return b=a.data,c=a.parent,d=a.target,d.update(b),d},key:function(a){return a.name}},observe:["name","attributes"],include:["config"]},a.prototype.update=function(a){return ko.mapping.fromJS(a,this.constructor.mapping,this),null!=a.config&&(this.config=a.config),this.configObserve(a.config)},a.prototype.getAttribute=function(a){return ko.utils.arrayFirst(this.attributes(),function(){return function(b){return b.name===a}}(this))},a.prototype.updateAttribute=function(a,b){var c;return c=this.getAttribute(a),null!=c?c.value(b):void 0},a.prototype.hasAttibuteWith=function(a){var b,c,d,e;for(e=this.attributes(),c=0,d=e.length;d>c;c++)if(b=e[c],a(b))return!0;return!1},a}(),f=function(){function a(a){ko.mapping.fromJS(a,this.constructor.mapping,this),this.group=ko.computed(function(a){return function(){return pimatic.getGroupOfRule(a.id)}}(this))}return a.mapping={key:function(a){return a.id},copy:["id"]},a.prototype.update=function(a){return ko.mapping.fromJS(a,this.constructor.mapping,this)},a}(),g=function(){function a(a){null==a.value&&(a.value=null),null==a.exprInputStr&&(a.exprInputStr=null),null==a.exprTokens&&(a.exprTokens=null),ko.mapping.fromJS(a,this.constructor.mapping,this),this.displayName=ko.computed(function(a){return function(){return"$"+a.name}}(this)),this.hasValue=ko.computed(function(a){return function(){return null!=a.value()}}(this)),this.displayValue=ko.computed(function(a){return function(){return a.hasValue()?a.value():"null"}}(this)),this.group=ko.computed(function(a){return function(){return pimatic.getGroupOfVariable(a.name)}}(this))}return a.mapping={key:function(a){return a.name},observe:["value","type","exprInputStr","exprTokens"]},a.prototype.isDeviceAttribute=function(){return-1!==$.inArray(".",this.name)},a.prototype.update=function(a){return ko.mapping.fromJS(a,this.constructor.mapping,this)},a}(),c=function(){function a(a){var b;ko.mapping.fromJS(a,this.constructor.mapping,this),this.groupsWithDevices=ko.computed(function(a){return function(){var b;return function(){var a,c,d,e;for(d=pimatic.groups(),e=[],a=0,c=d.length;c>a;a++)b=d[a],e.push(function(a){return function(b){var c;return c=ko.computed(function(){var c,d,e,f,g;for(f=a.devices(),g=[],d=0,e=f.length;e>d;d++)c=f[d],c.device.group()===b&&g.push(c);return g}),{group:b,devices:c}}}(this)(b));return e}.call(a)}}(this)),this.getUngroupedDevices=ko.computed(function(a){return function(){var b,c,d,e,f;for(e=a.devices(),f=[],c=0,d=e.length;d>c;c++)b=e[c],null==b.device.group()&&f.push(b);return f}}(this)),b=function(a,b){var c,d,e,f;if(a.length!==b.length)return!1;for(d=e=0,f=a.length;f>e;d=++e)if(c=a[d],c!==b[d])return!1;return!0}}return a.mapping={key:function(a){return a.id},copy:["id"],devices:{create:function(a){var b,c,d,e,f;return b=a.data,e=a.parent,f=a.skip,c=pimatic.getDeviceById(b.deviceId),null==c&&(c=pimatic.nullDevice),d=pimatic.templateClasses[c.template],null==d&&(console.warn("Could not find a template class for "+b.template),d=pimatic.DeviceItem),null==c?console.error("Device should never be null"):new d(b,c)},key:function(a){return a.deviceId}}},a.prototype.update=function(a){return ko.mapping.fromJS(a,this.constructor.mapping,this)},a.prototype.getDeviceTemplate=function(a){return a.getDeviceTemplate()},a.prototype.afterRenderDevice=function(a,b){return b.afterRender(a)},a}(),d=function(){function a(a){ko.mapping.fromJS(a,this.constructor.mapping,this),this.getDevices=ko.computed(function(a){return function(){var b,c,d,e,f,g;for(d=[],g=a.devices(),e=0,f=g.length;f>e;e++)b=g[e],c=pimatic.getDeviceById(b),null!=c&&d.push(c);return d}}(this)),this.getRules=ko.computed(function(a){return function(){var b,c,d,e,f,g;for(d=[],g=a.rules(),e=0,f=g.length;f>e;e++)b=g[e],c=pimatic.getRuleById(b),null!=c&&d.push(c);return d}}(this)),this.getVariables=ko.computed(function(a){return function(){var b,c,d,e,f,g;for(d=[],g=a.variables(),e=0,f=g.length;f>e;e++)b=g[e],c=pimatic.getVariableByName(b),null!=c&&d.push(c);return d}}(this))}return a.mapping={key:function(a){return a.id},copy:["id"]},a.prototype.update=function(a){return ko.mapping.fromJS(a,this.constructor.mapping,this)},a.prototype.getDevicesWithAttibute=function(a){var b;return function(){var c,d,e,f;for(e=this.getDevices(),f=[],c=0,d=e.length;d>c;c++)b=e[c],b.hasAttibuteWith(a)&&f.push(b);return f}.call(this)},a.prototype.getDevicesWithNumericAttribute=function(){return this.getDevicesWithAttibute(function(){return function(a){return"number"===a.type}}(this))},a.prototype.containsDevice=function(a){var b;return b=ko.utils.arrayIndexOf(this.devices(),a),-1!==b},a}(),e=function(){function b(){var a;window.pimatic=this,this.client=new DeclApiClient(api),this.updateFromJs({devices:[],rules:[],variables:[],devicepages:[],groups:[],errorCount:0,rememberme:!1,updateProcessStatus:"idle",updateProcessMessages:[]}),this.setupStorage(),this.updateProcessStatus.subscribe(function(){return function(a){switch(a){case"running":return pimatic.loading("update-process-status","show",{text:__("Installing updates, Please be patient")});default:return pimatic.loading("update-process-status","hide")}}}(this)),this.autosave=ko.computed(function(a){return function(){var b;return b=ko.mapping.toJS(a),pimatic.storage.set("pimatic.scope",b)}}(this)).extend({rateLimit:{timeout:500,method:"notifyWhenChangesStop"}}),a=!0,this.rememberme.subscribe(function(b){return function(c){var d;return a?$.get("remember",{rememberMe:c}).done(ajaxShowToast).fail(function(){return a=!1,b.rememberme(!c)}).fail(ajaxAlertFail):a=!0,d=pimatic.storage.get("pimatic"),pimatic.storage.removeAll(),pimatic.storage=c?$.localStorage:$.sessionStorage,d.scope.rememberMe=c,pimatic.storage.set("pimatic",d)}}(this)),this.getUngroupedDevices=ko.computed(function(a){return function(){var b,c,d,e,f;for(e=a.devices(),f=[],c=0,d=e.length;d>c;c++)b=e[c],null==b.group()&&f.push(b);return f}}(this))}return b.mapping={devices:{create:function(b){var c,d,e;return c=b.data,d=b.parent,e=b.skip,new a(c)},update:function(a){var b,c,d;return b=a.data,c=a.parent,d=a.target,d.update(b),d},key:function(a){return a.id}},rules:{create:function(a){var b,c,d;return b=a.data,c=a.parent,d=a.skip,new f(b)},update:function(a){var b,c,d;return b=a.data,c=a.parent,d=a.target,d.update(b),d},key:function(a){return a.id}},variables:{create:function(a){var b,c,d;return b=a.data,c=a.parent,d=a.skip,new g(b)},update:function(a){var b,c,d;return b=a.data,c=a.parent,d=a.target,d.update(b),d},key:function(a){return a.name}},devicepages:{create:function(a){var b,d,e;return b=a.data,d=a.parent,e=a.skip,new c(b)},update:function(a){var b,c,d;return b=a.data,c=a.parent,d=a.target,d.update(b),d},key:function(a){return a.id}},groups:{create:function(a){var b,c,e;return b=a.data,c=a.parent,e=a.skip,new d(b)},update:function(a){var b,c,d;return b=a.data,c=a.parent,d=a.target,d.update(b),d},key:function(a){return a.id}}},b.prototype.socket=null,b.prototype.inited=!1,b.prototype.pages={},b.prototype.storage=null,b.prototype.nullDevice=new a({id:"null",name:"null",attributes:[],actions:[],template:"null"}),b.prototype.loadDataFromStorage=function(){var a,b;if(this._dataLoaded=!0,pimatic.storage.isSet("pimatic.scope")){a=pimatic.storage.get("pimatic.scope");try{return this.updateFromJs(a)}catch(c){return b=c,TraceKit.report(b),pimatic.storage.removeAll(),window.location.reload()}}},b.prototype.updateFromJs=function(a){return ko.mapping.fromJS(a,b.mapping,this)},b.prototype.setupStorage=function(){return $.localStorage.isSet("pimatic")?(pimatic.storage=$.localStorage,$.sessionStorage.removeAll(),this.rememberme(!0)):$.sessionStorage.isSet("pimatic")?(pimatic.storage=$.sessionStorage,$.localStorage.removeAll(),this.rememberme(!1)):(pimatic.storage=$.sessionStorage,this.rememberme(!1),pimatic.storage.set("pimatic",{}))},b.prototype.getDeviceById=function(a){return ko.utils.arrayFirst(this.devices(),function(){return function(b){return b.id===a}}(this))},b.prototype.getGroupOfDevice=function(a){var b,c,d,e,f;for(f=this.groups(),d=0,e=f.length;e>d;d++)if(b=f[d],c=ko.utils.arrayIndexOf(b.devices(),a),-1!==c)return b;return null},b.prototype.updateDeviceAttribute=function(a,b,c){var d,e,f,g,h;for(g=this.devices(),h=[],e=0,f=g.length;f>e;e++){if(d=g[e],d.id===a){d.updateAttribute(b,c);break}h.push(void 0)}return h},b.prototype.updateDeviceFromJs=function(a){var c;return c=this.getDeviceById(a.id),null==c?(c=b.mapping.devices.create({data:a}),this.devices.push(c)):c.update(a)},b.prototype.updateDeviceOrder=function(a){var b;return b=function(b){var c;return c=$.inArray(b,a),-1===c?999999:c},this.devices.sort(function(){return function(a,c){return b(a.id)-b(c.id)}}(this))},b.prototype.removeDevice=function(a){return this.devices.remove(function(){return function(b){return b.id===a}}(this))},b.prototype.getPageById=function(a){return ko.utils.arrayFirst(this.devicepages(),function(){return function(b){return b.id===a}}(this))},b.prototype.removePage=function(a){return this.devicepages.remove(function(){return function(b){return b.id===a}}(this))},b.prototype.updatePageFromJs=function(a){var c;return c=this.getPageById(a.id),null==c?(c=b.mapping.devicepages.create({data:a}),this.devicepages.push(c)):c.update(a)},b.prototype.getGroupById=function(a){return ko.utils.arrayFirst(this.groups(),function(){return function(b){return b.id===a}}(this))},b.prototype.removeGroup=function(a){return this.groups.remove(function(){return function(b){return b.id===a}}(this))},b.prototype.updateGroupFromJs=function(a){var c;return c=this.getGroupById(a.id),null==c?(c=b.mapping.groups.create({data:a}),this.groups.push(c)):c.update(a)},b.prototype.getGroupOfRule=function(a){var b,c,d,e,f;for(f=this.groups(),d=0,e=f.length;e>d;d++)if(b=f[d],c=ko.utils.arrayIndexOf(b.rules(),a),-1!==c)return b;return null},b.prototype.updateGroupOrder=function(a){var b;return b=function(b){var c;return c=$.inArray(b,a),-1===c?999999:c},this.groups.sort(function(){return function(a,c){return b(a.id)-b(c.id)}}(this))},b.prototype.getRuleById=function(a){return ko.utils.arrayFirst(this.rules(),function(){return function(b){return b.id===a}}(this))},b.prototype.removeRule=function(a){return this.rules.remove(function(){return function(b){return b.id===a}}(this))},b.prototype.updateRuleFromJs=function(a){var c;return c=this.getRuleById(a.id),null==c?(c=b.mapping.rules.create({data:a}),this.rules.push(c)):c.update(a)},b.prototype.updateRuleOrder=function(a){var b;return b=function(b){var c;return c=$.inArray(b,a),-1===c?999999:c},this.rules.sort(function(){return function(a,c){return b(a.id)-b(c.id)}}(this))},b.prototype.removeVariable=function(a){return this.variables.remove(function(){return function(b){return b.name===a}}(this))},b.prototype.getVariableByName=function(a){return ko.utils.arrayFirst(this.variables(),function(){return function(b){return b.name===a}}(this))},b.prototype.updateVariableValue=function(a,b){var c;return c=this.getVariableByName(a),null!=c?c.value(b):void 0},b.prototype.updateVariableFromJs=function(a){var c;return c=this.getVariableByName(a.name),null==c?(c=b.mapping.variables.create({data:a}),this.variables.push(c)):c.update(a)},b.prototype.updateVariableOrder=function(a){var b;return b=function(b){var c;return c=$.inArray(b,a),-1===c?999999:c},this.variables.sort(function(){return function(a,c){return b(a.name)-b(c.name)}}(this))},b.prototype.getGroupOfVariable=function(a){var b,c,d,e,f;for(f=this.groups(),d=0,e=f.length;e>d;d++)if(b=f[d],c=ko.utils.arrayIndexOf(b.variables(),a),-1!==c)return b;return null},b}(),window.pimatic=new e,window.pimatic.Device=a,window.pimatic.Rule=f,window.pimatic.Group=d,window.pimatic.Variable=g,window.pimatic.DevicePage=c,$(document).on("pagebeforecreate",function(){pimatic._dataLoaded||pimatic.loadDataFromStorage()})}).call(this);